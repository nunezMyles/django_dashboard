{% extends 'layouts/base.html' %}

{% block title %} Dashboard {% endblock title %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}

    <div class="container-fluid pb-4">

      <!--  Block selection, Unit selection, Flat type, Area info Widgets  -->
      <div class="row mt-4">

        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-7">
                  <div class="numbers">
                    <p class="text-sm mb-0 text-capitalize font-weight-bold">Block</p>
                    <div class="dropdown">
                      <h5 id="text_blockName" class="dropbtn font-weight-bolder">-</h5>
                      <div id="ddlBlock_content" class="dropdown-content dropdown-content-block dropdown-scrollbar">
                        <input id="textfield_searchBlock" class="dropdown-content-item" type="text" placeholder="Search.." onkeyup="filterBlockFunction()">
                        <!--a class="dropdown-content-item font-weight-bold">401A</a>
                        <a class="dropdown-content-item font-weight-bold">402C</a>
                        <a class="dropdown-content-item font-weight-bold">403B</a>
                        <a class="dropdown-content-item font-weight-bold">404A</a>
                        <a class="dropdown-content-item font-weight-bold">405C</a-->
                      </div>
                    </div>
                    <a id="btnChangeBlock" class="dropdown-content-item text-secondary text-xs font-weight-bolder" data-toggle="tooltip" data-original-title="Edit block">
                      change
                    </a>
                  </div>
                </div>
                <div class="col-5 text-end my-auto">
                  <div class="icon icon-shape bg-gradient-info shadow text-center border-radius-md">
                    <i class="ni ni-building text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-7">
                  <div class="numbers">
                    <p class="text-sm mb-0 text-capitalize font-weight-bold">Unit no.</p>
                    <div class="dropdown">
                      <h5 id="text_unitName" class="dropbtn font-weight-bolder">-</h5>
                      <div id="ddlUnit_content" class="dropdown-content dropdown-content-unit dropdown-scrollbar">
                        <input id="textfield_searchUnit" class="dropdown-content-item" type="text" placeholder="Search.." onkeyup="filterUnitFunction()">
                      </div>
                    </div>
                    <a id="btnChangeUnit" class="dropdown-content-item text-secondary text-xs font-weight-bolder" data-toggle="tooltip" data-original-title="Edit unit">
                      change
                    </a>
                  </div>
                </div>
                <div class="col-5 text-end my-auto">
                  <div class="icon icon-shape bg-gradient-info shadow text-center border-radius-md">
                    <i class="ni ni-shop text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-7">
                  <div class="numbers">
                    <p class="text-sm mb-0 text-capitalize font-weight-bold">Flat Type</p>
                    <h5 id="text_flatType" class="font-weight-bolder">-</h5>
                    <span class="text-sm font-weight-bolder">-</span>
                  </div>
                </div>
                <div class="col-5 text-end my-auto">
                  <div class="icon icon-shape bg-gradient-info shadow text-center border-radius-md">
                    <i class="ni ni-collection text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-sm-6">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-7">
                  <div class="numbers">
                    <p class="text-sm mb-0 text-capitalize font-weight-bold">Area</p>
                    <h5 id="text_area" class="font-weight-bolder">-</h5>
                    <span id="text_street" class="text-xs font-weight-bolder">-</span>
                  </div>
                </div>
                <div class="col-5 text-end my-auto">
                  <div class="icon icon-shape bg-gradient-info shadow text-center border-radius-md">
                    <i class="ni ni-world text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!--  From/To Date selection Widget-->
      <div class="row mt-4 justify-content-md-center">
        <div class="col-xl-6 col-sm-6 mb-xl-0 mb-4">
          <div class="card">
            <div class="card-body p-3">
              <div class="row align-items-center">
                <div class="col-lg-2">
                  <p class="fromToLabel text-sm text-capitalize font-weight-bolder mb-auto text-center">FROM</p>
                </div>
                <div class="col-lg-4 mb-2 mt-2">
                  <input id="datepicker-start" class="form-control cursor-pointer" data-toggle="tooltip" type="date" />
                </div>
                <div class="col-lg-4 mb-2 mt-2">
                  <input id="timepicker-start" class="form-control cursor-pointer" type="time" />
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-6 col-sm-6 mb-xl-0 mb-4">
          <div class="card">
            <div class="card-body p-3">
              <div class="row align-items-center">
                <div class="col-lg-2">
                  <p class="fromToLabel text-sm text-capitalize font-weight-bolder mb-auto text-center">TO</p>
                </div>
                <div class="col-lg-4 mb-2 mt-2">
                  <input id="datepicker-end" class="form-control cursor-pointer" data-toggle="tooltip" type="date" />
                </div>
                <div class="col-lg-4 mb-2 mt-2">
                  <input id="timepicker-end" class="form-control cursor-pointer" type="time" />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!--  Smoking Frequency & Duration Doughnut Charts -->
      <div class="row mt-4">
        <div class="col-lg-6 mb-4">
          <div class="card">
            <div class="card-header pb-0">
              <div class="d-flex">
                <div class="me-auto">
                  <h6 id="text_scatterChartTitle">Smoking Frequency</h6>
                </div>
                <!--div class="row align-items-center ms-4 me-1">
                  <i class="fa-solid fa-arrows-rotate cursor-pointer" onclick="scatterChart_doughnutChart_Listview_Refresh()"></i>
                </div-->
              </div>
            </div>
            <div class="card-body p-3">
              <div class="chart">
                <canvas id="chart-doughnut-1" class="chart-canvas" height="300px"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-6 mb-4">
          <div class="card">
            <div class="card-header pb-0">
              <div class="d-flex">
                <div class="me-auto">
                  <h6 id="text_scatterChartTitle">Total Smoking Duration</h6>
                </div>
                <!--div class="row align-items-center ms-4 me-1">
                  <i class="fa-solid fa-arrows-rotate cursor-pointer" onclick="scatterChart_doughnutChart_Listview_Refresh()"></i>
                </div-->
              </div>
            </div>
            <div class="card-body p-3">
              <div class="chart">
                <canvas id="chart-doughnut-2" class="chart-canvas" height="300px"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!--  Smoking Events Scatter Chart & Listview-->
      <div class="row">
        <div class="col-lg-8 mb-4">
          <div class="card">
            <div class="card-header pb-0">
              <div class="d-flex">
                <div class="me-auto">
                  <h6 id="text_scatterChartTitle">Timeline of Smoking Events</h6>
                </div>
                <div class="row align-items-center ms-4 me-1">
                  <i class="fa-solid fa-magnifying-glass-minus cursor-pointer" onclick="scatterChartResetZoom()"></i>
                </div>
              </div>
            </div>
            <div class="card-body p-3">
              <div class="chart">
                <canvas id="chart-scatter" class="chart-canvas" height="350px"></canvas>
              </div>
            </div>

            <div id="modalImg" class="modal" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-xl">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Thermal & RGB Image</h5>
                  </div>
                  <div class="modal-body">
                    <div class="row justify-content-center">
                      <div class="col-lg-5">
                        <img id="imgThermal" src="" class="img-fluid" alt="Thermal image">
                      </div>
                      <div class="col-lg-7">
                        <img id="imgRgb" src="" class="img-fluid" alt="RGB image">
                      </div>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <!--button type="button" class="btn btn-primary">Save changes</button-->
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>

        <div class="col-lg-4 mb-4">
          <div class="card">
            <div class="card-header pb-0">
              <div class="d-flex">
                <div class="me-auto">
                  <h6 id="text_scatterChartTitle">All Smoking Events (By Latest)</h6>
                </div>
              </div>
            </div>
            <div class="card-body p-3">
              <ol id="listview_smokeEvents" class="list-group list-group-flush list-group-numbered">    

              </ol>
            </div>
          </div>
        </div>
      </div>

      <!--  Room selection radioBtn, Raspberry editBtn & Line Chart-->
      <div class="row">

        <!--div class="col-lg-5 d-flex">
          <div class="card mb-4">
            
            <div class="card-body px-0 pt-3 pb-0 ">
              <div id="floorplan-img-container">
                <a id="pulse1" class="pulse pulse-online" onclick="sensor_onClick(1)">
                  <i class="font-weight-bold">1</i>
                </a>
                <a id="pulse2" class="pulse pulse-offline" onclick="sensor_onClick(2)">
                  <i class="font-weight-bold">2</i>
                </a>
                <a id="pulse3" class="pulse pulse-online" onclick="sensor_onClick(3)">
                  <i class="font-weight-bold">3</i>
                </a>
                <a id="pulse4" class="pulse pulse-online" onclick="sensor_onClick(4)">
                  <i class="font-weight-bold">4</i>
                </a>
                <a id="pulse5" class="pulse pulse-offline" onclick="sensor_onClick(5)">
                  <i class="font-weight-bold">5</i>
                </a>
                <img src="/static/assets/img/floor-plans/4-room_5.png" alt="img-blur-shadow" class="img-fluid" />
              </div>
            </div>
          </div>
        </div-->
        
        <div class="col-lg-3 mb-4">
          <div class="card h-100">
            <div class="card-header pb-0">
              <h6>Select Room</h6>
            </div>
            <div class="card-body px-0 pt-0 pb-2">
              <div class="table-responsive p-0">
                <table class="table align-items-center mb-0">
                  <thead>
                    <tr>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7"></th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7"></th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>
                        <div class="d-flex px-2 py-1 justify-content-center">
                          <div class="d-flex flex-column justify-content-center">
                            <label class="radio-container pb-3">
                              <input id="radioBtn_s1" type="radio" name="radio">
                              <span class="radio-checkmark"></span>
                            </label>
                          </div>
                        </div>
                      </td>
                      <td>
                        <p class="text-xs font-weight-bold mb-0 ps-3">Bedroom 1</p>
                      </td>
                      <td class="align-middle">
                        <a id="btnEditRpi1" class="btnEditRpi text-secondary font-weight-bold text-xs" data-toggle="tooltip" data-original-title="Edit user">
                          Edit
                        </a>
                      </td>
                    </tr>
                    <tr>
                      <td>
                        <div class="d-flex px-2 py-1 justify-content-center">
                          <div class="d-flex flex-column justify-content-center">
                            <label class="radio-container pb-3">
                              <input id="radioBtn_s2" type="radio" name="radio">
                              <span class="radio-checkmark"></span>
                            </label>
                          </div>
                        </div>
                      </td>
                      <td>
                        <p class="text-xs font-weight-bold mb-0 ps-3">Bedroom 2</p>
                      </td>
                      <td class="align-middle">
                        <a id="btnEditRpi2" class="btnEditRpi text-secondary font-weight-bold text-xs" data-toggle="tooltip" data-original-title="Edit user">
                          Edit
                        </a>
                      </td>
                    </tr>
                    <tr>
                      <td>
                        <div class="d-flex px-2 py-1 justify-content-center">
                          <div class="d-flex flex-column justify-content-center">
                            <label class="radio-container pb-3">
                              <input id="radioBtn_s3" type="radio" name="radio">
                              <span class="radio-checkmark"></span>
                            </label>
                          </div>
                        </div>
                      </td>
                      <td>
                        <p class="text-xs font-weight-bold mb-0 ps-3">Bedroom 3</p>
                      </td>
                      <td class="align-middle">
                        <a id="btnEditRpi3" class="btnEditRpi text-secondary font-weight-bold text-xs" data-toggle="tooltip" data-original-title="Edit user">
                          Edit
                        </a>
                      </td>
                    </tr>
                    <tr>
                      <td>
                        <div class="d-flex px-2 py-1 justify-content-center">
                          <div class="d-flex flex-column justify-content-center">
                            <label class="radio-container pb-3">
                              <input id="radioBtn_s4" type="radio" name="radio">
                              <span class="radio-checkmark"></span>
                            </label>
                          </div>
                        </div>
                      </td>
                      <td>
                        <p class="text-xs font-weight-bold mb-0 ps-3">Living room</p>
                      </td>
                      <td class="align-middle">
                        <a id="btnEditRpi4" class="btnEditRpi text-secondary font-weight-bold text-xs" data-toggle="tooltip" data-original-title="Edit user">
                          Edit
                        </a>
                      </td>
                    </tr>
                    <tr>
                      <td>
                        <div class="d-flex px-2 py-1 justify-content-center">
                          <div class="d-flex flex-column justify-content-center">
                            <label class="radio-container pb-3">
                              <input id="radioBtn_s5" type="radio" name="radio">
                              <span class="radio-checkmark"></span>
                            </label>
                          </div>
                        </div>
                      </td>
                      <td>
                        <p class="text-xs font-weight-bold mb-0 ps-3">Kitchen</p>
                      </td>
                      <td class="align-middle">
                        <a id="btnEditRpi5" class="btnEditRpi text-secondary font-weight-bold text-xs" data-toggle="tooltip" data-original-title="Edit user">
                          Edit
                        </a>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-9 mb-4">
          <div class="card h-100">
            <div class="card-header pb-0">
              <div class="d-flex">
                <div class="me-auto">
                  <h6 id="text_lineChartTitle">Gas Concentration in - (No room selected)</h6>
                </div>
                <div class="row align-items-center ms-4 me-1">
                  <i class="fa-solid fa-magnifying-glass-minus cursor-pointer" onclick="lineChartResetZoom()"></i>
                </div>
              </div>
            </div>
            <div class="card-body p-3">
              <div class="chart">
                <canvas id="chart-line" class="chart-canvas" height="350px"></canvas>
              </div>
            </div>
          </div>
        </div>
        
      </div>

      {% include "includes/footer.html" %}

  
    </div>
    

{% endblock content %}

<!-- Specific JS goes HERE --> 
{% block javascripts %}

  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <!--script src="/static/assets/js/plugins/chartjs.min.js"></script-->
  <script src="/static/assets/js/plugins/chart.umd.js"></script>
  <script src="/static/assets/js/plugins/Chart.extension.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/interactiveimagejs@2.7.1/dist/interactive-image.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
  <script src="/static/assets/js/plugins/chartjs-plugin-zoom.min.js"></script>

  <!-- Init global variables -->
  <script>
    var global_lineChart;
    var ctx = document.getElementById("chart-line").getContext("2d");

    var global_scatterChart;
    var ctx2 = document.getElementById("chart-scatter").getContext("2d");

    var global_doughnutChart_freq;
    var ctx4 = document.getElementById("chart-doughnut-1").getContext("2d");

    var global_doughnutChart_duration;
    var ctx5 = document.getElementById("chart-doughnut-2").getContext("2d");

    var gradientStroke1 = ctx.createLinearGradient(0, 230, 0, 50);
    gradientStroke1.addColorStop(1, 'rgba(33,148,254,0.2)');
    gradientStroke1.addColorStop(0.2, 'rgba(72,72,176,0.0)');
    gradientStroke1.addColorStop(0, 'rgba(203,12,159,0)');

    var gradientStroke2 = ctx.createLinearGradient(0, 230, 0, 50);
    gradientStroke2.addColorStop(1, 'rgba(20,23,39,0.2)');
    gradientStroke2.addColorStop(0.2, 'rgba(72,72,176,0.0)');
    gradientStroke2.addColorStop(0, 'rgba(20,23,39,0)');
    
    var ddlBlock_isOpen = false;
    var ddlUnit_isOpen = false;

    var global_selected_block = "";
    var global_selected_unit = "";
    var global_selected_sensor = 0;

    var global_room_list = ['Bedroom 1', 'Bedroom 2', 'Bedroom 3', 'Living room', 'Kitchen']
    
    var radioBtnRpiIdTranslate = {
      "Room 1": 0,
      "Room 2": 0,
      "Room 3": 0,
      "Room 4": 0,
      "Room 5": 0
    };

    var editBtnRpiLocIdTranslate = {
      "Room 1": 0,
      "Room 2": 0,
      "Room 3": 0,
      "Room 4": 0,
      "Room 5": 0
    };

    var isScatterBedroom1Hidden = false;
    var isScatterBedroom2Hidden = false;
    var isScatterBedroom3Hidden = false;
    var isScatterLivingroomHidden = false;
    var isScatterKitchenHidden = false;
  </script>

  <!--  Init From/To date+timepickers onChange() -->
  <script>
    document.getElementById("datepicker-start").onchange = function(e) { dt_range_check(); }
    document.getElementById("timepicker-start").onchange = function(e) { dt_range_check(); }
    document.getElementById("datepicker-end").onchange = function(e) { dt_range_check(); }
    document.getElementById("timepicker-end").onchange = function(e) { dt_range_check(); }
  </script>

  <!--  Init dashboard refresh interval script  -->
  <script>
    function updateDashboard() {
      lineChartRefresh();
      scatterChart_doughnutChart_Listview_Refresh();
    }

    setInterval(updateDashboard, 5000); // every 5 seconds
  </script>

  <!--  Line/scatter chart unzoom script-->
  <script>
    function lineChartResetZoom() {
      global_lineChart.resetZoom(mode = 'easeOutQuart');
    }

    function scatterChartResetZoom() {
      global_scatterChart.resetZoom(mode = 'easeOutQuart');
    }
  </script>
  
  <!--  Edit rpi radioBtn onClick: enter admin page  -->
  <script>
    function btnEditOnClick(rpi_number) {
      if (radioBtnRpiIdTranslate['Room '+String(rpi_number)] == 0) {
        location.href = "/admin/dashboard_webapp/raspberry_location/add/";
      } else {
        var rpi_location_id = editBtnRpiLocIdTranslate['Room ' + String(rpi_number)]
        location.href = "/admin/dashboard_webapp/raspberry_location/" + rpi_location_id + "/change/";
      }
    }
  </script>

  <!--  Init timepicker & datepicker values -->
  <script>
    $(function() {
      // init datepicker-start: set start date to current day
      var today = new Date();
      var dd = String(today.getDate()).padStart(2, '0');
      var mm = String(today.getMonth() + 1).padStart(2, '0');
      var yyyy = today.getFullYear();
      today = yyyy + '-' + mm + '-' + dd;

      startDate = today;        
      document.getElementById("datepicker-start").value = startDate;
      document.getElementById("datepicker-start").max = startDate;
      
      // init timepicker-start: set start time to 12am
      startTime = "00:00" 
      document.getElementById("timepicker-start").value = startTime;

      // init datepicker-end: set end date to current day
      endDate = today;
      document.getElementById("datepicker-end").value = endDate;
      document.getElementById("datepicker-end").max = endDate;
      
      // init timepicker-end: set end time to current time
      function getTime(d){
        function pad(n){return n<10 ? '0'+n : n}
        return [
          pad(d.getUTCHours() + 8),':',
          pad(d.getUTCMinutes()),
        ].join("");
      }
      var rawDate = new Date();
      var formattedTime = getTime(rawDate);

      //endTime = formattedTime;
      endTime = "23:59";

      // Fix 24:00 error, should be 00:00 instead
      var endTime_hrs_str = endTime.toString().slice(0, 2);
      var endTime_hrs_int = parseInt(endTime_hrs_str);
      
      if (endTime_hrs_int >= 24) {
        var new_endTime_hrs_int = endTime_hrs_int - 24;
        var new_endTime_hrs_str = new_endTime_hrs_int.toString();
        if (new_endTime_hrs_int < 10) new_endTime_hrs_str = "0" + new_endTime_hrs_str;

        var endTime_mins_str = endTime.toString().slice(3, 5);
        var new_endTime_Str = new_endTime_hrs_str + ":" + endTime_mins_str;

        endTime = new_endTime_Str;
      }

      document.getElementById("timepicker-end").value = endTime;
    });
  </script>

  <!--  Listview reset + update -->
  <script>
    function listviewReset() {
      const listviewitem_smokeEvents = document.querySelectorAll('.listview-item-smokeEvent');
      listviewitem_smokeEvents.forEach(event => {
        event.remove();
      });
    }
  
    function listviewAdd(smokeEventsRooms) {
      var unordered_events = [];

      // Get all smoke events as items
      smokeEventsRooms.forEach(smokeEvents => {
        smokeEvents.forEach(event => {
          unordered_events.push(event);
        });
      });

      // Sort by oldest to latest (to show latest event on listview, nice display)
      var ordered_events = unordered_events.sort((a, b) => new Date(a[1]) - new Date(b[1]));
      ordered_events.reverse();
      
      // Add items to listview
      ordered_events.forEach(event => {
        const parentElement = document.querySelector('#listview_smokeEvents');
        const li = document.createElement('li');

        li.classList.add('list-group-item');
        li.classList.add('d-flex');
        li.classList.add('list-group-item-action');
        li.classList.add('listview-item-smokeEvent');

        room_name = event[0]
        datetime_start = event[1]
        datetime_end = event[2]
        duration = event[3]

        li.innerHTML = '<div class="ms-2 me-auto"><div class="d-flex w-100 justify-content-between"><p class="mb-1 text-s font-weight-bold">'
          + room_name + '</p></div><p class="mb-1 text-xs font-weight-bold">'
          + datetime_start + ' - ' + datetime_end + '</p><small class="text-xs font-weight-bold">'
          + duration + '</small></div>';
        parentElement.appendChild(li);
      });
    }
  </script>

  <!--  Init doughnutChart_frequency script  -->
  <script>
    const freq_plugin = {
      id: 'textCenter1',
      beforeDatasetsDraw(chart, args, pluginOptions) {
        const {ctx, data} = chart;
        const xCoor = chart.getDatasetMeta(0).data[0].x;
        const yCoor = chart.getDatasetMeta(0).data[0].y;
        ctx.save();
        
        ctx.font = 'bolder 35px sans-serif';
        ctx.fillStyle = 'black';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        var total_duration = 0
        data.datasets[0].data.forEach(duration => total_duration += duration)

        ctx.fillText(String(total_duration), xCoor, yCoor - 15);

        ctx.font = 'bolder 21px sans-serif';
        ctx.fillStyle = 'black';
        ctx.fillText('events', xCoor, yCoor + 20);
      }
    };

    $(function() {
      global_doughnutChart_freq = new Chart(ctx4, config = {
        type: "doughnut",
        data: {
          labels: [
            'Bedroom 1',
            'Bedroom 2',
            'Bedroom 3',
            'Living Room',
            'Kitchen',
          ],
          datasets: [{
            data: [0, 0, 0, 0, 0],
            backgroundColor: [
              'rgb(255, 99, 132)',
              'rgb(255, 205, 86)',
              'rgb(75, 192, 192)',
              'rgb(54, 162, 235)',
              'rgb(153, 102, 255)',
            ],
            hoverOffset: 4
          }]
        },
        plugins: [freq_plugin],
        options: {
          parsing: false,
          animation: true,
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.parsed + ' events';
                }
              },
            }
          },
          responsive: true,
          maintainAspectRatio: false,
        },
      });
    });
  </script>

  <!--  Init doughnutChart_duration script  -->
  <script>
    const duration_plugin = {
      id: 'textCenter2',
      beforeDatasetsDraw(chart, args, pluginOptions) {
        const {ctx, data} = chart;
        const xCoor = chart.getDatasetMeta(0).data[0].x;
        const yCoor = chart.getDatasetMeta(0).data[0].y;
        ctx.save();
        
        ctx.font = 'bolder 35px sans-serif';
        ctx.fillStyle = 'black';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        var total_duration = 0
        data.datasets[0].data.forEach(duration => total_duration += duration)

        ctx.fillText(String(total_duration), xCoor, yCoor - 15);

        ctx.font = 'bolder 21px sans-serif';
        ctx.fillStyle = 'black';
        ctx.fillText('minutes', xCoor, yCoor + 20);
      }
    };
    
    $(function() {
      global_doughnutChart_duration = new Chart(ctx5, config = {
        type: "doughnut",
        data: {
          labels: [
            'Bedroom 1',
            'Bedroom 2',
            'Bedroom 3',
            'Living Room',
            'Kitchen',
          ],
          datasets: [{
            data: [0, 0, 0, 0, 0],
            backgroundColor: [
              'rgb(255, 99, 132)',
              'rgb(255, 205, 86)',
              'rgb(75, 192, 192)',
              'rgb(54, 162, 235)',
              'rgb(153, 102, 255)',
            ],
            hoverOffset: 4
          }]
        },
        plugins: [duration_plugin],
        options: {
          parsing: false,
          animation: true,
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.parsed + ' mins';
                }
              },
            }
          },
          responsive: true,
          maintainAspectRatio: false,
        },
      });
    });
  </script>

  <!--  DoughnutCharts refresh   -->
  <script>
    function doughnutChartFreqRefresh() {
      if (global_selected_block == "" || global_selected_unit == "") {
        global_doughnutChart_freq.data.datasets[0].data[0] = 0;
        global_doughnutChart_freq.data.datasets[0].data[1] = 0;
        global_doughnutChart_freq.data.datasets[0].data[2] = 0;
        global_doughnutChart_freq.data.datasets[0].data[3] = 0;
        global_doughnutChart_freq.data.datasets[0].data[4] = 0;

        global_doughnutChart_freq.update();
      }
    }

    function doughnutChartDurationRefresh() {
      if (global_selected_block == "" || global_selected_unit == "") {
        global_doughnutChart_duration.data.datasets[0].data[0] = 0;
        global_doughnutChart_duration.data.datasets[0].data[1] = 0;
        global_doughnutChart_duration.data.datasets[0].data[2] = 0;
        global_doughnutChart_duration.data.datasets[0].data[3] = 0;
        global_doughnutChart_duration.data.datasets[0].data[4] = 0;

        global_doughnutChart_duration.update();
      }
    }
  </script>

  <!--  Init lineChart script   -->
  <script>
    $(function() {
      global_lineChart = new Chart(ctx, config = {
        type: "line",
        data: {
          datasets: [
            {
              data: [],
              label: "CO actual",
              //backgroundColor: gradientStroke1,
              tension: 0.4,
              borderWidth: 0,
              pointRadius: 0,
              borderColor: "#2194fe",
              borderWidth: 3,
              maxBarThickness: 6,
            },
            {
              label: "CO threshold",
              data: [],
              borderDash: [10,10],
              tension: 0.4,
              borderWidth: 0,
              pointRadius: 0,
              borderColor: "#2194fe",
              borderWidth: 3,
              //backgroundColor: gradientStroke2,
              maxBarThickness: 6
            },
            {
              data: [],
              label: "NH3 actual",
              //backgroundColor: gradientStroke1,
              tension: 0.4,
              borderWidth: 0,
              pointRadius: 0,
              borderColor: "#3A416F",
              borderWidth: 3,
              maxBarThickness: 6,
            },
            {
              label: "NH3 threshold",
              data: [],
              borderDash: [10,10],
              tension: 0.4,
              borderWidth: 0,
              pointRadius: 0,
              borderColor: "#3A416F",
              borderWidth: 3,
              //backgroundColor: gradientStroke2,
              maxBarThickness: 6
            },
            {
              data: [],
              label: "CH2O actual",
              //backgroundColor: gradientStroke1,
              tension: 0.4,
              borderWidth: 0,
              pointRadius: 0,
              borderColor: "#d65eb9",
              borderWidth: 3,
              maxBarThickness: 6,
            },
            {
              label: "CH2O threshold",
              data: [],
              borderDash: [10,10],
              tension: 0.4,
              borderWidth: 0,
              pointRadius: 0,
              borderColor: "#d65eb9",
              borderWidth: 3,
              //backgroundColor: gradientStroke2,
              maxBarThickness: 6
            },
            {
              data: [],
              label: "HCN actual",
              //backgroundColor: gradientStroke1,
              tension: 0.4,
              borderWidth: 0,
              pointRadius: 0,
              borderColor: "#41e151",
              borderWidth: 3,
              maxBarThickness: 6,
            },
            {
              label: "HCN threshold",
              data: [],
              borderDash: [10,10],
              tension: 0.4,
              borderWidth: 0,
              pointRadius: 0,
              borderColor: "#41e151",
              borderWidth: 3,
              //backgroundColor: gradientStroke2,
              maxBarThickness: 6
            },
            {
              data: [],
              label: "VOC actual",
              //backgroundColor: gradientStroke1,
              tension: 0.4,
              borderWidth: 0,
              pointRadius: 0,
              borderColor: "#cc2e49",
              borderWidth: 3,
              maxBarThickness: 6,
            },
            {
              label: "VOC threshold",
              data: [],
              borderDash: [10,10],
              tension: 0.4,
              borderWidth: 0,
              pointRadius: 0,
              borderColor: "#cc2e49",
              borderWidth: 3,
              //backgroundColor: gradientStroke2,
              maxBarThickness: 6
            },
          ],
          labels: [], // start with empty x-axis dataset
        },
        options: {
          spanGaps: true,
          animation: false,
          plugins: {
            legend: {
              position: 'top'
            },
            tooltip: {
              enabled: true,
              mode: 'index',
              intersect: false,
              position: 'nearest',
            },
            zoom: {
              zoom: {
                wheel: {
                  enabled: true,
                  speed: 0.2,
                },
                pinch: {
                  enabled: true,
                  speed: 0.2,
                },
                mode: 'x',
              },
              pan: {
                enabled: true,
                mode: 'x',
              }
            }
          },
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              suggestedMin: 0,
              suggestedMax: 100,
              title: {
                display: true,
                text: 'Gas Concentration (ppm)',
                font: {
                  size: 14
                },
              }, 
              gridLines: {
                borderDash: [2],
                borderDashOffset: [2],
                color: '#dee2e6',
                zeroLineColor: '#dee2e6',
                zeroLineWidth: 1,
                zeroLineBorderDash: [2],
                drawBorder: false,
              },
              ticks: {
                beginAtZero: true,
                padding: 10,
                fontSize: 11,
                fontColor: '#adb5bd',
                lineHeight: 3,
                fontStyle: 'normal',
                fontFamily: "Open Sans",
              },
            },
            x: {
              title: {
                display: true,
                text: 'Datetime',
                font: {
                  size: 13
                },
              }, 
              grid: {
                display: false,
              },
              ticks: {
                autoSkip: true,     // interval setting
                maxTicksLimit: 10,  // interval setting
                padding: 10,
                fontSize: 11,
                fontColor: '#adb5bd',
                lineHeight: 3,
                fontStyle: 'normal',
                fontFamily: "Open Sans",
              },
              
            },
          },
        },
      });
    });
  </script>

  <!--  LineChart refresh   -->
  <script>
    function lineChartRefresh() {

      // selected sensor must have valid id first, else reset line chart
      if (global_selected_sensor == 0) {
        lineChartResetZoom();
        global_lineChart.data.datasets[0].data = [];
        global_lineChart.data.labels = [];
        global_lineChart.update();

        return;
      }

      var startDate = $("#datepicker-start").val();   // returns 2022-12-31
      var startTime = $("#timepicker-start").val();   // returns 16:43
      var endDate = $("#datepicker-end").val();
      var endTime = $("#timepicker-end").val();
      //document.getElementById("label-test").innerHTML = "New text!";

      if (startDate == "") {
        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
        var mm = String(today.getMonth() + 1).padStart(2, '0');
        var yyyy = today.getFullYear();
        today = yyyy + '-' + mm + '-' + dd;

        startDate = today;        
        document.getElementById("datepicker-start").value = startDate;
      }
      
      if (startTime == "") {
        startTime = "00:00"   // use 12am for startTime
        document.getElementById("timepicker-start").value = startTime;
      }

      if (endDate == "") {
        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
        var mm = String(today.getMonth() + 1).padStart(2, '0');
        var yyyy = today.getFullYear();
        today = yyyy + '-' + mm + '-' + dd;

        endDate = today;
        document.getElementById("datepicker-end").value = endDate;
      }
      
      if (endTime == "") {
        function getTime(d){
          function pad(n){return n<10 ? '0'+n : n}
          return [
            pad(d.getUTCHours() + 8),':',
            pad(d.getUTCMinutes()),
          ].join("");
        }

        var rawDate = new Date();
        var formattedTime = getTime(rawDate);

        endTime = formattedTime;
        document.getElementById("timepicker-end").value = endTime;
      }
      
      $.ajax({
        type: "GET",
        url: "/fetchData-lineChart/" + String(global_selected_sensor) + "/" + startDate + "/" + startTime + "/" + endDate + "/" + endTime + "/",
        success: function(response) {
          global_lineChart.data.labels = response.labels;

          global_lineChart.data.datasets[0].data = response['co_actual_data'];
          global_lineChart.data.datasets[2].data = response['nh3_actual_data'];
          global_lineChart.data.datasets[4].data = response['ch2o_actual_data'];
          global_lineChart.data.datasets[6].data = response['hcn_actual_data'];
          global_lineChart.data.datasets[8].data = response['voc_actual_data'];

          global_lineChart.data.datasets[1].data = response['co_threshold_data'];
          global_lineChart.data.datasets[3].data = response['nh3_threshold_data'];
          global_lineChart.data.datasets[5].data = response['ch2o_threshold_data'];
          global_lineChart.data.datasets[7].data = response['hcn_threshold_data'];
          global_lineChart.data.datasets[9].data = response['voc_threshold_data'];
          
          global_lineChart.update();
        },
        error: function(xhr, status, error) {
          http_error_handler(xhr);
        }
      });
    }

  </script>

  <!--  ScatterChart dataset onClick(), show thermal and rgb images -->
  <script>
    document.getElementById("chart-scatter").onclick = function(e) {
      const points = global_scatterChart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);

      // If onClick() occurs on an existing scatter point
      if (points.length) {
        var thermalImg = document.getElementById("imgThermal");
        var rgbimg = document.getElementById("imgRgb");
        var modalTitle = document.getElementById("exampleModalLabel");

        // Reset modal context
        thermalImg.src = "";
        rgbimg.src = "";
        modalTitle.innerHTML = "Thermal & RGB Image, ";

        // Show modal immediately on click
        var myModal = new bootstrap.Modal(document.getElementById('modalImg'), {
          keyboard: false,
        });

        myModal.show();

        const firstPoint = points[0];

        // Get AJAX url parameters
        const label = global_scatterChart.data.datasets[firstPoint.datasetIndex].label;
        const value = global_scatterChart.data.datasets[firstPoint.datasetIndex].data[firstPoint.index];

        var rpiId = radioBtnRpiIdTranslate["Room " + String(global_room_list.indexOf(label) + 1)];
        var datetime_in_ms = value['x'];

        $.ajax({
          type: "GET",
          url: "/fetchData-thermalRgbImage/" + rpiId + "/" + datetime_in_ms + "/",
          success: function(response) {

            // Set modal context once ajax success -> By displaying images + datetime modal title
            thermalImg.src = response['thermalData'];
            rgbimg.src = response['rgbData'];

            modalTitle.innerHTML = "Thermal & RGB Image, " + response['datetime'];
          },
          error: function(xhr, status, error) {
            http_error_handler(xhr);
          }
        });

      }
    };
  </script>

  <!--  ScatterChart legend onClick() -->
  <script>
    const newLegendClickHandler = function(e, legendItem, legend) {
      var selected_room_name = legendItem['text'];

      switch(selected_room_name) {
        case "Bedroom 1":
        isScatterBedroom1Hidden = !isScatterBedroom1Hidden;
          break;

        case "Bedroom 2":
          isScatterBedroom2Hidden = !isScatterBedroom2Hidden;
          break;

        case "Bedroom 3":
          isScatterBedroom3Hidden = !isScatterBedroom3Hidden;
          break;

        case "Living room":
          isScatterLivingroomHidden = !isScatterLivingroomHidden;
          break;

        case "Kitchen":
          isScatterKitchenHidden = !isScatterKitchenHidden;
          break;

        default:
          break;
      }

      legend.chart.data.datasets.forEach( function(val, index, arr) {
        if (val['label'] == selected_room_name) {
          val['hidden'] = !val['hidden'];
        }
      });      

      legend.chart.update();
    }
  </script>

  <!--  Init scatterChart script   -->
  <script>
    $(function() {
      global_scatterChart = new Chart(ctx2, config = {
        type: "scatter",
        data: {
          datasets: [{
              data: [], // start with empty y-axis dataset
              label: "Bedroom 1",
              tension: 0.4,
              pointRadius: 3,
              borderColor: 'rgb(255, 99, 132)',
              borderWidth: 4,
              maxBarThickness: 6,
            },
            {
              data: [],
              label: "Bedroom 2",
              tension: 0.4,
              pointRadius: 3,
              borderColor: 'rgb(255, 205, 86)',
              borderWidth: 4,
              maxBarThickness: 6,
            },
            {
              data: [], 
              label: "Bedroom 3",
              tension: 0.4,
              pointRadius: 3,
              borderColor: 'rgb(75, 192, 192)',
              borderWidth: 4,
              maxBarThickness: 6,
            },
            {
              data: [],
              label: "Living room",
              tension: 0.4,
              pointRadius: 3,
              borderColor: 'rgb(54, 162, 235)',
              borderWidth: 4,
              maxBarThickness: 6,
            },
            {
              data: [],
              label: "Kitchen",
              tension: 0.4,
              pointRadius: 3,
              borderColor: 'rgb(153, 102, 255)',
              borderWidth: 4,
              maxBarThickness: 6,
            },
          ],
        },
        options: {
          showLine: true,
          parsing: false,
          animation: false,
          plugins: {
            legend: {
              display: true,
              labels: {
                generateLabels: function(chart) {
                  return [
                    {
                      text: "Bedroom 1",
                      datasetIndex: 0,
                      fillStyle: 'rgb(255, 99, 132)',
                      strokeStyle: 'rgb(255, 99, 132)',
                      hidden: isScatterBedroom1Hidden,
                    },
                    {
                      text: "Bedroom 2",
                      datasetIndex: 1,
                      fillStyle: 'rgb(255, 205, 86)',
                      strokeStyle: 'rgb(255, 205, 86)',
                      hidden: isScatterBedroom2Hidden,
                    },
                    {
                      text: "Bedroom 3",
                      datasetIndex: 2,
                      fillStyle: 'rgb(75, 192, 192)',
                      strokeStyle: 'rgb(75, 192, 192)',
                      hidden: isScatterBedroom3Hidden,
                    },
                    {
                      text: "Living room",
                      datasetIndex: 3,
                      fillStyle: 'rgb(54, 162, 235)',
                      strokeStyle: 'rgb(54, 162, 235)',
                      hidden: isScatterLivingroomHidden,
                    },
                    {
                      text: "Kitchen",
                      datasetIndex: 4,
                      fillStyle: 'rgb(153, 102, 255)',
                      strokeStyle: 'rgb(153, 102, 255)',
                      hidden: isScatterKitchenHidden,
                    },
                  ];
                },
              },
              onClick: newLegendClickHandler,
            },
            zoom: {
              zoom: {
                wheel: {
                  enabled: true,
                  speed: 0.3,
                },
                pinch: {
                  enabled: true,
                  speed: 0.3,
                },
                mode: 'x',
              },
              pan: {
                enabled: true,
                mode: 'x',
              }
            },
            tooltip: {
              enabled: true,
              mode: "nearest",
              intersect: true,
              callbacks: {
                  label: function(context) {
                    var date_from_ms = new Date(context.parsed.x);

                    // Get date format
                    var dd = String(date_from_ms.getDate()).padStart(2, '0');
                    var mmm = String(date_from_ms.toLocaleString('en-us',{month:'short'}));
                    var yyyy = date_from_ms.getFullYear();
                    formatted_date = dd + ' ' + mmm + ' ' + yyyy;

                    // Get time format
                    function getTime(d) {
                      function pad(n) {return n<10 ? '0'+n : n}
                      return [
                        pad(d.getUTCHours() + 8),':',
                        pad(d.getUTCMinutes()), ':',
                        pad(d.getUTCSeconds())
                      ].join("");
                    }
                    var formatted_time = getTime(date_from_ms);

                    // Room: data.datasets[tooltipItems.datasetIndex].label
                    
                    return formatted_date + ' ' + formatted_time;
                  }
              },
            },
          },
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              display: true,
              grid: {
                display: true,
              },
              border: {
                display: false,
              },
              ticks: {
                maxTicksLimit: 10,
                display: false,
                beginAtZero: true,
                padding: 10,
                fontSize: 11,
                fontColor: '#adb5bd',
                lineHeight: 3,
                fontStyle: 'normal',
                fontFamily: "Open Sans",
              },
            },
            x: {
              title: {
                display: true,
                text: 'Datetime',
                font: {
                  size: 14
                },
              }, 
              suggestedMax: 1577846300000,
              grid: {
                display: false,
              },
              ticks: {
                autoSkip: true,     // interval setting
                maxTicksLimit: 10,  // interval setting
                padding: 10,
                fontSize: 11,
                fontColor: '#adb5bd',
                lineHeight: 3,
                fontStyle: 'normal',
                fontFamily: "Open Sans",
                callback: function(value, index, values) {
                  var date_from_ms = new Date(value);

                  // Get date format
                  var dd = String(date_from_ms.getDate()).padStart(2, '0');
                  var mmm = String(date_from_ms.toLocaleString('en-us',{month:'short'}));
                  var yyyy = date_from_ms.getFullYear();
                  formatted_date = dd + ' ' + mmm + ' ' + yyyy;

                  // Get time format
                  function getTime(d){
                    function pad(n){return n<10 ? '0'+n : n}
                    return [
                      pad(d.getUTCHours() + 8),':',
                      pad(d.getUTCMinutes()),
                    ].join("");
                  }
                  var formatted_time = getTime(date_from_ms);

                  return formatted_date + ' ' + formatted_time;
                }
              },
              
            },
          },
        },
      });
    });
  </script>

  <!--  Scatter Chart + Doughnut Chart + Listview refresh   -->
  <script>
    function scatterChart_doughnutChart_Listview_Refresh() {

      // must have selected block and unit, else reset scatter chart
      if (global_selected_block == "" || global_selected_unit == "") {
        scatterChartResetZoom();
        global_scatterChart.data.datasets = [{
          data: [],
          label: "Bedroom 1",
          tension: 0.4,
          pointRadius: 2,
          borderColor: 'rgb(255, 99, 132)',
          borderWidth: 4,
          maxBarThickness: 6,
        },
        {
          data: [],
          label: "Bedroom 2",
          tension: 0.4,
          pointRadius: 2,
          borderColor: 'rgb(255, 205, 86)',
          borderWidth: 4,
          maxBarThickness: 6,
        },
        {
          data: [], 
          label: "Bedroom 3",
          tension: 0.4,
          pointRadius: 2,
          borderColor: 'rgb(75, 192, 192)',
          borderWidth: 4,
          maxBarThickness: 6,
        },
        {
          data: [],
          label: "Living room",
          tension: 0.4,
          pointRadius: 2,
          borderColor: 'rgb(54, 162, 235)',
          borderWidth: 4,
          maxBarThickness: 6,
        },
        {
          data: [],
          label: "Kitchen",
          tension: 0.4,
          pointRadius: 2,
          borderColor: 'rgb(153, 102, 255)',
          borderWidth: 4,
          maxBarThickness: 6,
        }];

        global_scatterChart.update();
        return;
      }

      var startDate = $("#datepicker-start").val(); 
      var startTime = $("#timepicker-start").val(); 
      var endDate = $("#datepicker-end").val();
      var endTime = $("#timepicker-end").val();

      if (startDate == "") {
        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
        var mm = String(today.getMonth() + 1).padStart(2, '0');
        var yyyy = today.getFullYear();
        today = yyyy + '-' + mm + '-' + dd;

        startDate = today;        
        document.getElementById("datepicker-start").value = startDate;
      }
      
      if (startTime == "") {
        startTime = "00:00"   // use 12am for startTime
        document.getElementById("timepicker-start").value = startTime;
      }

      if (endDate == "") {
        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
        var mm = String(today.getMonth() + 1).padStart(2, '0');
        var yyyy = today.getFullYear();
        today = yyyy + '-' + mm + '-' + dd;

        endDate = today;
        document.getElementById("datepicker-end").value = endDate;
      }
      
      if (endTime == "") {
        function getTime(d){
          function pad(n){return n<10 ? '0'+n : n}
          return [
            pad(d.getUTCHours() + 8),':',
            pad(d.getUTCMinutes()),
          ].join("");
        }

        var rawDate = new Date();
        var formattedTime = getTime(rawDate);

        endTime = formattedTime;
        document.getElementById("timepicker-end").value = endTime;
      }
      
      $.ajax({
        type: "GET",
        url: "/fetchData-scatterChart-doughnutChart-listview/" + global_selected_block + "/" + global_selected_unit.slice(1,7) + "/" + startDate + "/" + startTime + "/" + endDate + "/" + endTime + "/",
        success: function(response) {
          global_scatterChart.data.datasets = [{
            data: [],
            label: "Bedroom 1",
            tension: 0.4,
            pointRadius: 2,
            borderColor: 'rgb(255, 99, 132)',
            borderWidth: 4,
            maxBarThickness: 6,
          },
          {
            data: [],
            label: "Bedroom 2",
            tension: 0.4,
            pointRadius: 2,
            borderColor: 'rgb(255, 205, 86)',
            borderWidth: 4,
            maxBarThickness: 6,
          },
          {
            data: [], 
            label: "Bedroom 3",
            tension: 0.4,
            pointRadius: 2,
            borderColor: 'rgb(75, 192, 192)',
            borderWidth: 4,
            maxBarThickness: 6,
          },
          {
            data: [],
            label: "Living room",
            tension: 0.4,
            pointRadius: 2,
            borderColor: 'rgb(54, 162, 235)',
            borderWidth: 4,
            maxBarThickness: 6,
          },
          {
            data: [],
            label: "Kitchen",
            tension: 0.4,
            pointRadius: 2,
            borderColor: 'rgb(153, 102, 255)',
            borderWidth: 4,
            maxBarThickness: 6,
          }];

          response['scatterChartData'].forEach(room => {
            room.forEach(session => {
              switch (response['scatterChartData'].indexOf(room)) {

                // Bedroom 1
                case 0: 
                  global_scatterChart.data.datasets.push(
                    {
                      data: session,
                      label: "Bedroom 1",
                      tension: 0.4,
                      pointRadius: 4,
                      pointBorderWidth: 8,
                      pointBorderColor: 'rgb(255, 99, 132)',
                      borderColor: 'rgb(0, 0, 0)',
                      borderWidth: 2,
                      hidden: isScatterBedroom1Hidden,
                    },
                  );
                  break;

                // Bedroom 2
                case 1:
                  global_scatterChart.data.datasets.push(
                    {
                      data: session,
                      label: "Bedroom 2",
                      tension: 0.4,
                      pointRadius: 4,
                      pointBorderWidth: 8,
                      pointBorderColor: 'rgb(255, 205, 86)',
                      borderColor: 'rgb(0, 0, 0)',
                      borderWidth: 2,
                      hidden: isScatterBedroom2Hidden,
                    },
                  );
                  break;
                
                // Bedroom 3
                case 2:
                  global_scatterChart.data.datasets.push(
                    {
                      data: session, 
                      label: "Bedroom 3",
                      tension: 0.4,
                      pointRadius: 4,
                      pointBorderWidth: 8,
                      pointBorderColor: 'rgb(75, 192, 192)',
                      borderColor: 'rgb(0, 0, 0)',
                      borderWidth: 2,
                      hidden: isScatterBedroom3Hidden,
                    },
                  );
                  break;

                // Living room
                case 3:
                  global_scatterChart.data.datasets.push(
                    {
                      data: session,
                      label: "Living room",
                      tension: 0.4,
                      pointRadius: 4,
                      pointBorderWidth: 8,
                      pointBorderColor: 'rgb(54, 162, 235)',
                      borderColor: 'rgb(0, 0, 0)',
                      borderWidth: 2,
                      hidden: isScatterLivingroomHidden,
                    },
                  );
                  break;

                // Kitchen
                case 4:
                  global_scatterChart.data.datasets.push(
                    {
                      data: session,
                      label: "Kitchen",
                      tension: 0.4,
                      pointRadius: 4,
                      pointBorderWidth: 8,
                      pointBorderColor: 'rgb(153, 102, 255)',
                      borderColor: 'rgb(0, 0, 0)',
                      borderWidth: 2,
                      hidden: isScatterKitchenHidden,
                    },
                  );
                  break;

                default:
                  break;
              }
            })
          });

          global_scatterChart.update();

          global_doughnutChart_freq.data.datasets[0].data[0] = response['doughnutChartDataFreq'][0];
          global_doughnutChart_freq.data.datasets[0].data[1] = response['doughnutChartDataFreq'][1];
          global_doughnutChart_freq.data.datasets[0].data[2] = response['doughnutChartDataFreq'][2];
          global_doughnutChart_freq.data.datasets[0].data[3] = response['doughnutChartDataFreq'][3];
          global_doughnutChart_freq.data.datasets[0].data[4] = response['doughnutChartDataFreq'][4];

          global_doughnutChart_freq.update();

          global_doughnutChart_duration.data.datasets[0].data[0] = response['doughnutChartDataDuration'][0];
          global_doughnutChart_duration.data.datasets[0].data[1] = response['doughnutChartDataDuration'][1];
          global_doughnutChart_duration.data.datasets[0].data[2] = response['doughnutChartDataDuration'][2];
          global_doughnutChart_duration.data.datasets[0].data[3] = response['doughnutChartDataDuration'][3];
          global_doughnutChart_duration.data.datasets[0].data[4] = response['doughnutChartDataDuration'][4];

          global_doughnutChart_duration.update();

          listviewReset();
          listviewAdd(response['listViewData']);
        },
        error: function(xhr, status, error) {
          http_error_handler(xhr);
        }
      });
    }

  </script>

  <!--  Init radioBtns + editBtns script  -->
  <script>
      var radioBtn_1 = document.getElementById("radioBtn_s1");
      var radioBtn_2 = document.getElementById("radioBtn_s2");
      var radioBtn_3 = document.getElementById("radioBtn_s3");
      var radioBtn_4 = document.getElementById("radioBtn_s4");
      var radioBtn_5 = document.getElementById("radioBtn_s5");

      radioBtn_1.disabled = true;
      radioBtn_2.disabled = true;
      radioBtn_3.disabled = true;
      radioBtn_4.disabled = true;
      radioBtn_5.disabled = true;

      radioBtn_1.onclick = function(e) { sensor_onClick(1); }
      radioBtn_2.onclick = function(e) { sensor_onClick(2); }
      radioBtn_3.onclick = function(e) { sensor_onClick(3); }
      radioBtn_4.onclick = function(e) { sensor_onClick(4); }
      radioBtn_5.onclick = function(e) { sensor_onClick(5); }

      var editBtn_1 = document.getElementById("btnEditRpi1");
      var editBtn_2 = document.getElementById("btnEditRpi2");
      var editBtn_3 = document.getElementById("btnEditRpi3");
      var editBtn_4 = document.getElementById("btnEditRpi4");
      var editBtn_5 = document.getElementById("btnEditRpi5");

      editBtn_1.onclick = function(e) { btnEditOnClick(1); }
      editBtn_2.onclick = function(e) { btnEditOnClick(2); }
      editBtn_3.onclick = function(e) { btnEditOnClick(3); }
      editBtn_4.onclick = function(e) { btnEditOnClick(4); }
      editBtn_5.onclick = function(e) { btnEditOnClick(5); }
  </script>

  <!--  Dropdown_unit onClick: update dashboard context script 	-->
  <script>
    function dropDownItem_Unit_onClick(selected_unit) {

      // if selected unit = previously selected unit, dont refresh line chart & rb info table
      var unitNameText = document.getElementById("text_unitName");

      if (unitNameText.innerHTML == selected_unit) {
        return;
      }     

      // else, set corresponding text
      global_selected_unit = selected_unit;
      unitNameText.innerHTML = selected_unit;

      // uncheck + enable all radio btns
      var radioBtn_s1 = document.getElementById("radioBtn_s1");
      var radioBtn_s2 = document.getElementById("radioBtn_s2");
      var radioBtn_s3 = document.getElementById("radioBtn_s3");
      var radioBtn_s4 = document.getElementById("radioBtn_s4");
      var radioBtn_s5 = document.getElementById("radioBtn_s5");

      radioBtn_s1.disabled = false;
      radioBtn_s2.disabled = false;
      radioBtn_s3.disabled = false;
      radioBtn_s4.disabled = false;
      radioBtn_s5.disabled = false;

      radioBtn_s1.checked = false;
      radioBtn_s2.checked = false;
      radioBtn_s3.checked = false;
      radioBtn_s4.checked = false;
      radioBtn_s5.checked = false;

      // close dropdownlist_unit
      var searchUnitText = document.getElementById("textfield_searchUnit");
      var dropdowns = document.getElementsByClassName("dropdown-content-unit");

      ddlUnit_isOpen = false;

      if (searchUnitText.value != "") {
        searchUnitText.value = "";
        filterUnitFunction();
      }
      
      for (let i = 0; i < dropdowns.length; i++) {
        var openDropdown = dropdowns[i];
        if (openDropdown.classList.contains('dropdown-toggle')) {
          openDropdown.classList.remove('dropdown-toggle');
        }
      }

      // call line chart reset
      var text_lineChartTitle = document.getElementById("text_lineChartTitle");
      text_lineChartTitle.innerHTML = "Gas Concentration in - (No room selected)";
      global_selected_sensor = 0;

      lineChartRefresh();
      scatterChart_doughnutChart_Listview_Refresh();
      listviewReset();
      doughnutChartFreqRefresh();
      doughnutChartDurationRefresh();

      $.ajax({
        type: "GET",
        url: "/fetchUnitInfo/" + global_selected_block + "/" + global_selected_unit.slice(1,7) + "/", // remove '#' from #14-101 to prevent interfere w/ url
        success: function(response) {

          editBtnRpiLocIdTranslate["Room 1"] = response['rpiLocIds'][0]
          editBtnRpiLocIdTranslate["Room 2"] = response['rpiLocIds'][1]
          editBtnRpiLocIdTranslate["Room 3"] = response['rpiLocIds'][2]
          editBtnRpiLocIdTranslate["Room 4"] = response['rpiLocIds'][3]
          editBtnRpiLocIdTranslate["Room 5"] = response['rpiLocIds'][4]

          // set corresponding text
          var flatTypeText = document.getElementById("text_flatType");
          flatTypeText.innerHTML = response['unit_info'][0][5];

          // set corresponding text for 'raspberry info' table
          var isBedroom1Updated = false;
          var isBedroom2Updated = false;
          var isBedroom3Updated = false;
          var isLivingRoomUpdated = false;
          var isKitchenUpdated = false;

          // Algorithm to update 'raspberry info' html based on given room names from JsonResponse
          response['unit_info'].forEach(function(element) {
            switch(element[4]) {

              case 'Bedroom 1':
                //rbIdText_1.innerHTML = element[3];
                radioBtnRpiIdTranslate["Room 1"] = element[3];
                isBedroom1Updated = true;
                break;

              case 'Bedroom 2':
                //rbIdText_2.innerHTML = element[3];
                radioBtnRpiIdTranslate["Room 2"] = element[3];
                isBedroom2Updated = true;
                break;

              case 'Bedroom 3':
                //rbIdText_3.innerHTML = element[3];
                radioBtnRpiIdTranslate["Room 3"] = element[3];
                isBedroom3Updated = true;
                break;

              case 'Living room':
                //rbIdText_4.innerHTML = element[3];
                radioBtnRpiIdTranslate["Room 4"] = element[3];
                isLivingRoomUpdated = true;
                break;

              case 'Kitchen':
                //rbIdText_5.innerHTML = element[3];
                radioBtnRpiIdTranslate["Room 5"] = element[3];
                isKitchenUpdated = true;
                break;

              default:
                break;
            }
          });

          // if room name not in jsonResponse, set html for that room to display no info
          if (!isBedroom1Updated) {
            //rbIdText_1.innerHTML = "-";
            radioBtnRpiIdTranslate["Room 1"] = 0;
            radioBtn_s1.disabled = true;
          }
          if (!isBedroom2Updated) {
            //rbIdText_2.innerHTML = "-";
            radioBtnRpiIdTranslate["Room 2"] = 0;
            radioBtn_s2.disabled = true;
          }
          if (!isBedroom3Updated) {
            //rbIdText_3.innerHTML = "-";
            radioBtnRpiIdTranslate["Room 3"] = 0;
            radioBtn_s3.disabled = true;
          }
          if (!isLivingRoomUpdated) {
            //rbIdText_4.innerHTML = "-";
            radioBtnRpiIdTranslate["Room 4"] = 0;
            radioBtn_s4.disabled = true;
          }
          if (!isKitchenUpdated) {
            //rbIdText_5.innerHTML = "-";
            radioBtnRpiIdTranslate["Room 5"] = 0;
            radioBtn_s5.disabled = true;
          }
        },
        error: function(xhr, status, error) {
          http_error_handler(xhr);
        }
      });

    }
  </script>

  <!--  Dropdown_block onClick: update dashboard context script -->
  <script>
    function dropDownItem_Block_onClick(selected_block) {

    // if selected block = previously selected block, dont refresh dashboard
    var blockNameText = document.getElementById("text_blockName");
    var unitNameText = document.getElementById("text_unitName");
    var flatTypeText = document.getElementById("text_flatType");

    // If chosen block = current block, do nothing
    if (blockNameText.innerHTML == selected_block) {
      return;
    }   

    // Reset option translations
    radioBtnRpiIdTranslate["Room 1"] = 0;
    radioBtnRpiIdTranslate["Room 2"] = 0;
    radioBtnRpiIdTranslate["Room 3"] = 0;
    radioBtnRpiIdTranslate["Room 4"] = 0;
    radioBtnRpiIdTranslate["Room 5"] = 0;

    editBtnRpiLocIdTranslate["Room 1"] = 0;
    editBtnRpiLocIdTranslate["Room 2"] = 0;
    editBtnRpiLocIdTranslate["Room 3"] = 0;
    editBtnRpiLocIdTranslate["Room 4"] = 0;
    editBtnRpiLocIdTranslate["Room 5"] = 0;

    //  Update corresponding text
    global_selected_block = selected_block;
    blockNameText.innerHTML = selected_block;
    unitNameText.innerHTML = "-"; 
    flatTypeText.innerHTML = "-";

    // Close dropdownlist_block + reset ddl's search field
    var searchBlockText = document.getElementById("textfield_searchBlock");
    var dropdowns = document.getElementsByClassName("dropdown-content-block");

    ddlBlock_isOpen = false;

    if (searchBlockText.value != "") {
      searchBlockText.value = "";
      filterBlockFunction();
    }

    for (let i = 0; i < dropdowns.length; i++) {
      var openDropdown = dropdowns[i];
      if (openDropdown.classList.contains('dropdown-toggle')) {
        openDropdown.classList.remove('dropdown-toggle');
      }
    }

    // Uncheck + disable all radio btns
    var radioBtn_s1 = document.getElementById("radioBtn_s1");
    var radioBtn_s2 = document.getElementById("radioBtn_s2");
    var radioBtn_s3 = document.getElementById("radioBtn_s3");
    var radioBtn_s4 = document.getElementById("radioBtn_s4");
    var radioBtn_s5 = document.getElementById("radioBtn_s5");

    radioBtn_s1.disabled = true;
    radioBtn_s2.disabled = true;
    radioBtn_s3.disabled = true;
    radioBtn_s4.disabled = true;
    radioBtn_s5.disabled = true;

    radioBtn_s1.checked = false;
    radioBtn_s2.checked = false;
    radioBtn_s3.checked = false;
    radioBtn_s4.checked = false;
    radioBtn_s5.checked = false;

    // call line chart reset
    var text_lineChartTitle = document.getElementById("text_lineChartTitle");
    text_lineChartTitle.innerHTML = "Gas Concentration in - (No room selected)";
    global_selected_sensor = 0;
    global_selected_unit = ""

    lineChartRefresh();  
    scatterChart_doughnutChart_Listview_Refresh();
    listviewReset();
    doughnutChartFreqRefresh();
    doughnutChartDurationRefresh();

    $.ajax({
      type: "GET",
      url: "/fetchUnits/" + selected_block + "/",
      success: function(response) {

        // Update corresponding text
        var unitAreaText = document.getElementById("text_area");
        var unitStreetText = document.getElementById("text_street");

        unitAreaText.innerHTML = response['units'][0][6];
        unitStreetText.innerHTML = response['units'][0][7];

        // Delete existing units in dropdownlist_units
        const unitChoices = document.querySelectorAll('.dropdown-item-unit');
        unitChoices.forEach(unit => {
          unit.remove();
        });

        // Algorithm to filter out repeating unit numbers, we want distinct units
        var array = response['units'];
        var unique = [];
        var distinct = [];
        for( let i = 0; i < array.length; i++ ){
          if( !unique[array[i][2]]){
            distinct.push(array[i][2]);
            unique[array[i][2]] = 1;
          }
        }
          
        // Add filtered units into dropdownlist_units
        distinct.forEach(function(element) {
          const parentElement = document.querySelector('#ddlUnit_content');
          const div = document.createElement('div');
          div.innerHTML = '<a class="dropdown-content-item dropdown-item-unit font-weight-bold" onclick="dropDownItem_Unit_onClick(this.innerText)">' + element + '</a>';
          parentElement.appendChild(div);
        });

        // Open dropdownlist_units
        if (!ddlUnit_isOpen) {
          btnChangeUnit_onClick();
        }

      },
      error: function(xhr, status, error) {
        http_error_handler(xhr);
      }
    });
    }
  </script>

  <!--  Init dropdownlists script 	-->
  <script>
    document.getElementById("btnChangeBlock").onclick = function(e) { btnChangeBlock_onClick(); }
    document.getElementById("btnChangeUnit").onclick = function(e) { btnChangeUnit_onClick(); }

    $(function() {
      $.ajax({
        type: "GET",
        url: "/fetchBlocks/",
        success: function(response) {

          // Add blocks into dropdownlist for blocks
          response['blocks'].forEach(function(element) {
            const parentElement = document.querySelector('#ddlBlock_content');
            const div = document.createElement('div');
            div.innerHTML = '<a class="dropdown-content-item font-weight-bold" onclick="dropDownItem_Block_onClick(this.innerText)">' + element + '</a>';
            parentElement.appendChild(div);
          });

        },
        error: function(xhr, status, error) {
          http_error_handler(xhr);
        }
      });
    });

  </script>

  <!--  Dropdownlist_block&unit isToggled + own search bar script   -->
  <script>
    function btnChangeBlock_onClick() {
      document.getElementById("ddlBlock_content").classList.toggle("dropdown-toggle");
      ddlBlock_isOpen = true;
    }

    function btnChangeUnit_onClick() {
      document.getElementById("ddlUnit_content").classList.toggle("dropdown-toggle");
      ddlUnit_isOpen = true;
    }

    const onClickOutside = (e) => {
      // if either dropdownlists are open + mouse click occured outside
      if ((ddlBlock_isOpen || ddlUnit_isOpen) && !e.target.className.includes('dropdown-content-item')) {

        ddlBlock_isOpen = false;
        ddlUnit_isOpen = false;
        var dropdowns = document.getElementsByClassName("dropdown-content");
        var searchBlockText = document.getElementById("textfield_searchBlock");
        var searchUnitText = document.getElementById("textfield_searchUnit");

        // reset dropdown searchBlock text
        if (searchBlockText.value != "") {
          searchBlockText.value = "";
          filterBlockFunction();
        }

        // reset dropdown searchUnit text
        if (searchUnitText.value != "") {
          searchUnitText.value = "";
          filterUnitFunction();
        }        

        // close drop down list
        for (let i = 0; i < dropdowns.length; i++) {
          var openDropdown = dropdowns[i];
          if (openDropdown.classList.contains('dropdown-toggle')) {
            openDropdown.classList.remove('dropdown-toggle');
          }
        }

      }
    };

    window.addEventListener("click", onClickOutside);

    function filterBlockFunction() {
      var input = document.getElementById("textfield_searchBlock");
      var filter = input.value.toUpperCase();

      var div = document.getElementById("ddlBlock_content");
      var a = div.getElementsByTagName("a");

      for (let i = 0; i < a.length; i++) {
        txtValue = a[i].textContent || a[i].innerText;
        if (txtValue.toUpperCase().indexOf(filter) > -1) {
          a[i].style.display = "";
        } else {
          a[i].style.display = "none";
        }
      }
    }

    function filterUnitFunction() {
      var input = document.getElementById("textfield_searchUnit");
      var filter = input.value.toUpperCase();

      var div = document.getElementById("ddlUnit_content");
      var a = div.getElementsByTagName("a");

      for (let i = 0; i < a.length; i++) {
        txtValue = a[i].textContent || a[i].innerText;
        if (txtValue.toUpperCase().indexOf(filter) > -1) {
          a[i].style.display = "";
        } else {
          a[i].style.display = "none";
        }
      }
    }

  </script>

  <!--  Http error handler script   -->
  <script>
    function http_error_handler(xhr) {
      if (xhr.status === 400) {
        // Bad/invalid request
        alert("We're sorry, but there seems to be a problem with the request you are trying to make.");
      } else if (xhr.status === 401) {
        // Unauthorized
        alert("We're sorry, but you are not authorized to access the requested resource.");
      } else if (xhr.status === 403) {
        // Forbidden
        alert("We're sorry, but you are not permitted to access the requested resource.");
      } else if (xhr.status === 404) {
        // Not found
        alert('The resource you are looking for does not exist.');
      } else if (xhr.status === 408) {
        // Request Timeout
        alert("Your request has timed out.");
      } else if (xhr.status === 500) {
        // Not found
        alert("We're sorry, but there has been an error on the server");
      } else {
        // Other error
        alert('An error occurred: ' + error);
      }
    }
  </script>

  <!--  Rpi radioBtn onClick: update line chart script   -->
  <script>  
    function sensor_onClick(selected_sensor) {
      var text_lineChartTitle = document.getElementById("text_lineChartTitle");

      var selected_room = global_room_list[selected_sensor - 1]

      text_lineChartTitle.innerHTML = "Gas Concentration in " + selected_room;
      global_selected_sensor = radioBtnRpiIdTranslate["Room " + selected_sensor];
      lineChartRefresh();
    }
  </script>

  <!--  Charts datetime range checker script   -->
  <script>
    function dt_range_check() {
      current_date_start = document.getElementById("datepicker-start").value;
      current_date_end = document.getElementById("datepicker-end").value;
      current_time_start = document.getElementById("timepicker-start").value;
      current_time_end = document.getElementById("timepicker-end").value;

      if (current_date_start > current_date_end) {
        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
        var mm = String(today.getMonth() + 1).padStart(2, '0');
        var yyyy = today.getFullYear();
        today = yyyy + '-' + mm + '-' + dd;

        document.getElementById("datepicker-end").value = today;
        document.getElementById("timepicker-start").value = "00:00";
        alert("Invalid date. Please select a date within the acceptable range.");
      }

      else if (current_date_start == current_date_end && current_time_start > current_time_end) {        
        document.getElementById("timepicker-start").value = "00:00";
        document.getElementById("timepicker-end").value = "23:59";
        alert("Invalid time. Please select a time within the acceptable range.");
      }

      lineChartRefresh();
      scatterChart_doughnutChart_Listview_Refresh();
      listviewReset();
      doughnutChartFreqRefresh();
      doughnutChartDurationRefresh();
    }
  </script>

  

{% endblock javascripts %}
