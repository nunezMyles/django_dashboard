{% extends 'layouts/base.html' %}

{% block title %} Dashboard {% endblock title %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}

    <div class="container-fluid pb-4">

      <div class="row mt-4">

        
        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-7">
                  <div class="numbers">
                    <p class="text-sm mb-0 text-capitalize font-weight-bold">Block</p>
                    <div class="dropdown">
                      <h5 id="text_blockName" class="dropbtn font-weight-bolder">-</h5>
                      <div id="ddlBlock_content" class="dropdown-content dropdown-content-block dropdown-scrollbar">
                        <input id="textfield_searchBlock" class="dropdown-content-item" type="text" placeholder="Search.." onkeyup="filterBlockFunction()">
                        <!--a class="dropdown-content-item font-weight-bold">401A</a>
                        <a class="dropdown-content-item font-weight-bold">402C</a>
                        <a class="dropdown-content-item font-weight-bold">403B</a>
                        <a class="dropdown-content-item font-weight-bold">404A</a>
                        <a class="dropdown-content-item font-weight-bold">405C</a-->
                      </div>
                    </div>
                    <a id="btnChangeBlock" onclick="btnChangeBlock_onClick()" class="dropdown-content-item text-secondary text-xs font-weight-bolder" data-toggle="tooltip" data-original-title="Edit block">
                      change
                    </a>
                  </div>
                </div>
                <div class="col-5 text-end my-auto">
                  <div class="icon icon-shape bg-gradient-info shadow text-center border-radius-md">
                    <i class="ni ni-building text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-7">
                  <div class="numbers">
                    <p class="text-sm mb-0 text-capitalize font-weight-bold">Unit no.</p>
                    <div class="dropdown">
                      <h5 id="text_unitName" class="dropbtn font-weight-bolder">-</h5>
                      <div id="ddlUnit_content" class="dropdown-content dropdown-content-unit dropdown-scrollbar">
                        <input id="textfield_searchUnit" class="dropdown-content-item" type="text" placeholder="Search.." onkeyup="filterUnitFunction()">
                        <!--a class="dropdown-content-item font-weight-bold">#03-101</a>
                        <a class="dropdown-content-item font-weight-bold">#09-107</a>
                        <a class="dropdown-content-item font-weight-bold">#14-101</a>
                        <a class="dropdown-content-item font-weight-bold">#14-107</a-->
                      </div>
                    </div>
                    <a id="btnChangeUnit" onclick="btnChangeUnit_onClick()" class="dropdown-content-item text-secondary text-xs font-weight-bolder" data-toggle="tooltip" data-original-title="Edit unit">
                      change
                    </a>
                  </div>
                </div>
                <div class="col-5 text-end my-auto">
                  <div class="icon icon-shape bg-gradient-info shadow text-center border-radius-md">
                    <i class="ni ni-shop text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-7">
                  <div class="numbers">
                    <p class="text-sm mb-0 text-capitalize font-weight-bold">Flat Type</p>
                    <h5 id="text_flatType" class="font-weight-bolder">-</h5>
                    <span class="text-sm font-weight-bolder">-</span>
                  </div>
                </div>
                <div class="col-5 text-end my-auto">
                  <div class="icon icon-shape bg-gradient-info shadow text-center border-radius-md">
                    <i class="ni ni-collection text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-sm-6">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-7">
                  <div class="numbers">
                    <p class="text-sm mb-0 text-capitalize font-weight-bold">Area</p>
                    <h5 id="text_area" class="font-weight-bolder">-</h5>
                    <span id="text_street" class="text-xs font-weight-bolder">-</span>
                  </div>
                </div>
                <div class="col-5 text-end my-auto">
                  <div class="icon icon-shape bg-gradient-info shadow text-center border-radius-md">
                    <i class="ni ni-world text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <div class="row mt-4">

        <!--div class="col-lg-5 d-flex">
          <div class="card mb-4">
            
            <div class="card-body px-0 pt-3 pb-0 ">
              <div id="floorplan-img-container">
                <a id="pulse1" class="pulse pulse-online" onclick="sensor_onClick(1)">
                  <i class="font-weight-bold">1</i>
                </a>
                <a id="pulse2" class="pulse pulse-offline" onclick="sensor_onClick(2)">
                  <i class="font-weight-bold">2</i>
                </a>
                <a id="pulse3" class="pulse pulse-online" onclick="sensor_onClick(3)">
                  <i class="font-weight-bold">3</i>
                </a>
                <a id="pulse4" class="pulse pulse-online" onclick="sensor_onClick(4)">
                  <i class="font-weight-bold">4</i>
                </a>
                <a id="pulse5" class="pulse pulse-offline" onclick="sensor_onClick(5)">
                  <i class="font-weight-bold">5</i>
                </a>
                <img src="/static/assets/img/floor-plans/4-room_5.png" alt="img-blur-shadow" class="img-fluid" />
              </div>
            </div>
          </div>
        </div-->
        
        <div class="col-lg-12">
          <div class="card mb-4">
            <div class="card-header pb-0">
              <h6>Raspberry Pi Info</h6>
            </div>
            <div class="card-body px-0 pt-0 pb-2">
              <div class="table-responsive p-0">
                <table class="table align-items-center mb-0">
                  <thead>
                    <tr>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7"></th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Allocated Room</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Id</th>
                      <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Status</th>
                      <!--th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Ip address</th-->
                      <th class="text-secondary opacity-7"></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>
                        <div class="d-flex px-2 py-1 justify-content-center">
                          <div class="d-flex flex-column justify-content-center">
                            <label class="radio-container pb-3">
                              <input id="radioBtn_s1" type="radio" name="radio" onclick="sensor_onClick(1)">
                              <span class="radio-checkmark"></span>
                            </label>
                          </div>
                        </div>
                      </td>
                      <td>
                        <p class="text-xs font-weight-bold mb-0 ps-3">Bedroom 1</p>
                      </td>
                      <td>
                        <p id="text_raspberryId1" class="text-xs font-weight-bold mb-0 pe-3">-</p>
                      </td>
                      <td class="align-middle text-center text-sm">
                        <span id="text_raspberryStatus1" class="badge badge-sm bg-gradient-success">Active</span>
                      </td>
                      <!--td class="align-middle text-center">
                        <span class="text-secondary text-xs font-weight-bold">192.168.1.101</span>
                      </td-->
                      <td class="align-middle">
                        <a href="javascript:;" class="text-secondary font-weight-bold text-xs" data-toggle="tooltip" data-original-title="Edit user">
                          Edit
                        </a>
                      </td>
                    </tr>
                    <tr>
                      <td>
                        <div class="d-flex px-2 py-1 justify-content-center">
                          <div class="d-flex flex-column justify-content-center">
                            <label class="radio-container pb-3">
                              <input id="radioBtn_s2" type="radio" name="radio" onclick="sensor_onClick(2)">
                              <span class="radio-checkmark"></span>
                            </label>
                          </div>
                        </div>
                      </td>
                      <td>
                        <p class="text-xs font-weight-bold mb-0 ps-3">Bedroom 2</p>
                      </td>
                      <td>
                        <p id="text_raspberryId2" class="text-xs font-weight-bold mb-0 pe-3">-</p>
                      </td>
                      <td class="align-middle text-center text-sm">
                        <span id="text_raspberryStatus2" class="badge badge-sm bg-gradient-secondary">Inactive</span>
                      </td>
                      <!--td class="align-middle text-center">
                        <span class="text-secondary text-xs font-weight-bold">192.168.1.102</span>
                      </td-->
                      <td class="align-middle">
                        <a href="#!" class="text-secondary font-weight-bold text-xs" data-toggle="tooltip" data-original-title="Edit user">
                          Edit
                        </a>
                      </td>
                    </tr>
                    <tr>
                      <td>
                        <div class="d-flex px-2 py-1 justify-content-center">
                          <div class="d-flex flex-column justify-content-center">
                            <label class="radio-container pb-3">
                              <input id="radioBtn_s3" type="radio" name="radio" onclick="sensor_onClick(3)">
                              <span class="radio-checkmark"></span>
                            </label>
                          </div>
                        </div>
                      </td>
                      <td>
                        <p class="text-xs font-weight-bold mb-0 ps-3">Bedroom 3</p>
                      </td>
                      <td>
                        <p id="text_raspberryId3" class="text-xs font-weight-bold mb-0 pe-3">-</p>
                      </td>
                      <td class="align-middle text-center text-sm">
                        <span id="text_raspberryStatus3" class="badge badge-sm bg-gradient-success">Active</span>
                      </td>
                      <!--td class="align-middle text-center">
                        <span class="text-secondary text-xs font-weight-bold">192.168.1.103</span>
                      </td-->
                      <td class="align-middle">
                        <a href="#!" class="text-secondary font-weight-bold text-xs" data-toggle="tooltip" data-original-title="Edit user">
                          Edit
                        </a>
                      </td>
                    </tr>
                    <tr>
                      <td>
                        <div class="d-flex px-2 py-1 justify-content-center">
                          <div class="d-flex flex-column justify-content-center">
                            <label class="radio-container pb-3">
                              <input id="radioBtn_s4" type="radio" name="radio" onclick="sensor_onClick(4)">
                              <span class="radio-checkmark"></span>
                            </label>
                          </div>
                        </div>
                      </td>
                      <td>
                        <p class="text-xs font-weight-bold mb-0 ps-3">Living room</p>
                      </td>
                      <td>
                        <p id="text_raspberryId4" class="text-xs font-weight-bold mb-0 pe-3">-</p>
                      </td>
                      <td class="align-middle text-center text-sm">
                        <span id="text_raspberryStatus4" class="badge badge-sm bg-gradient-success">Active</span>
                      </td>
                      <!--td class="align-middle text-center">
                        <span class="text-secondary text-xs font-weight-bold">192.168.1.104</span>
                      </td-->
                      <td class="align-middle">
                        <a href="#!" class="text-secondary font-weight-bold text-xs" data-toggle="tooltip" data-original-title="Edit user">
                          Edit
                        </a>
                      </td>
                    </tr>
                    <tr>
                      <td>
                        <div class="d-flex px-2 py-1 justify-content-center">
                          <div class="d-flex flex-column justify-content-center">
                            <label class="radio-container pb-3">
                              <input id="radioBtn_s5" type="radio" name="radio" onclick="sensor_onClick(5)">
                              <span class="radio-checkmark"></span>
                            </label>
                          </div>
                        </div>
                      </td>
                      <td>
                        <p class="text-xs font-weight-bold mb-0 ps-3">Kitchen</p>
                      </td>
                      <td>
                        <p id="text_raspberryId5" class="text-xs font-weight-bold mb-0 pe-3">-</p>
                      </td>
                      <td class="align-middle text-center text-sm">
                        <span id="text_raspberryStatus5" class="badge badge-sm bg-gradient-secondary">Inactive</span>
                      </td>
                      <!--td class="align-middle text-center">
                        <span class="text-secondary text-xs font-weight-bold">192.168.1.105</span>
                      </td-->
                      <td class="align-middle">
                        <a href="#!" class="text-secondary font-weight-bold text-xs" data-toggle="tooltip" data-original-title="Edit user">
                          Edit
                        </a>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row mb-4">
        <div class="col-lg-13">
          <div class="card">
            <div class="card-header pb-0">
              <div class="d-flex">
                <div class="me-auto">
                  <h6 id="text_lineChartTitle">Gas Sensor Reading in Room -</h6>
                </div>
                
                <div class="row align-items-center">
                  <div class="col-lg-2">
                    <span class="text-xs font-weight-bolder">FROM</span>
                  </div>
                  <div class="col-lg-5">
                    <input id="datepicker-start" class="form-control cursor-pointer" data-toggle="tooltip" type="date" onchange="dt_range_check()" />
                  </div>
                  <div class="col-lg-5">
                    <input id="timepicker-start" class="form-control cursor-pointer" type="time" onchange="dt_range_check()" />
                  </div>
                </div>

                <div class="row align-items-center ms-4 me-1">
                  <div class="col-lg-2">
                    <span id="label-test" class="text-xs font-weight-bolder">TO</span>
                  </div>
                  <div class="col-lg-5">
                    <input id="datepicker-end" class="form-control cursor-pointer" type="date" onchange="dt_range_check()" />
                  </div>
                  <div class="col-lg-5">
                    <input id="timepicker-end" class="form-control cursor-pointer" type="time" onchange="dt_range_check()" />
                  </div>
                </div>

                <!--div class="row align-items-center ms-4 me-1">
                  <i class="fa-solid fa-arrows-rotate cursor-pointer" onclick="lineChartRefresh()"></i>
                </div-->

              </div>
            </div>
            <div class="card-body p-3">
              <div class="chart">
                <canvas id="chart-line" class="chart-canvas" height="300px"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row mb-4">
        <div class="col-lg-13">
          <div class="card">
            <div class="card-header pb-0">
              <div class="d-flex">
                <div class="me-auto">
                  <h6 id="text_scatterChartTitle">Smoking Occurences Identified</h6>
                </div>
              </div>
            </div>
            <div class="card-body p-3">
              <div class="chart">
                <canvas id="chart-scatter" class="chart-canvas" height="300px"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row mb-4">
        <div class="col-lg-13">
          <div class="card">
            <div class="card-header pb-0">
              <div class="d-flex">
                <div class="me-auto">
                  <h6 id="text_barChartTitle">Total Smoking Duration of All Occurences (in Mins)</h6>
                </div>
              </div>
            </div>
            <div class="card-body p-3">
              <div class="chart">
                <canvas id="chart-bar" class="chart-canvas" height="300px"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      {% include "includes/footer.html" %}

    </div>
    

{% endblock content %}

<!-- Specific JS goes HERE --> 
{% block javascripts %}

  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script src="/static/assets/js/plugins/chartjs.min.js"></script>
  <script src="/static/assets/js/plugins/Chart.extension.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/interactiveimagejs@2.7.1/dist/interactive-image.min.js"></script>

  <!-- init global variables -->
  <script>
    var global_lineChart;
    var ctx = document.getElementById("chart-line").getContext("2d");

    var global_scatterChart;
    var ctx2 = document.getElementById("chart-scatter").getContext("2d");

    var global_barChart;
    var ctx3 = document.getElementById("chart-bar").getContext("2d");

    var gradientStroke1 = ctx.createLinearGradient(0, 230, 0, 50);
    gradientStroke1.addColorStop(1, 'rgba(33,148,254,0.2)');
    gradientStroke1.addColorStop(0.2, 'rgba(72,72,176,0.0)');
    gradientStroke1.addColorStop(0, 'rgba(203,12,159,0)');

    var gradientStroke2 = ctx.createLinearGradient(0, 230, 0, 50);
    gradientStroke2.addColorStop(1, 'rgba(20,23,39,0.2)');
    gradientStroke2.addColorStop(0.2, 'rgba(72,72,176,0.0)');
    gradientStroke2.addColorStop(0, 'rgba(20,23,39,0)');
    
    var ddlBlock_isOpen = false;
    var ddlUnit_isOpen = false;

    var global_selected_block = "";
    var global_selected_unit = "";
    var global_selected_sensor = 0;
    
    var sensorSelectTranslate = {
      sens1: 0,
      sens2: 0,
      sens3: 0,
      sens4: 0,
      sens5: 0
    };
  </script>

  <!-- init timepicker & datepicker values -->
  <script>
    $(function() {
      // init datepicker-start: set start date to current day
      var today = new Date();
      var dd = String(today.getDate()).padStart(2, '0');
      var mm = String(today.getMonth() + 1).padStart(2, '0');
      var yyyy = today.getFullYear();
      today = yyyy + '-' + mm + '-' + dd;

      startDate = today;        
      document.getElementById("datepicker-start").value = startDate;
      document.getElementById("datepicker-start").max = startDate;
      
      // init timepicker-start: set start time to 12am
      startTime = "00:00" 
      document.getElementById("timepicker-start").value = startTime;

      // init datepicker-end: set end date to current day
      endDate = today;
      document.getElementById("datepicker-end").value = endDate;
      document.getElementById("datepicker-end").max = endDate;
      
      // init timepicker-end: set end time to current time
      function getTime(d){
        function pad(n){return n<10 ? '0'+n : n}
        return [
          pad(d.getUTCHours() + 8),':',
          pad(d.getUTCMinutes()),
        ].join("");
      }
      var rawDate = new Date();
      var formattedTime = getTime(rawDate);

      endTime = formattedTime;
      document.getElementById("timepicker-end").value = endTime;
    });
  </script>

  <!--  init lineChart script   -->
  <script>
    $(function() {
      global_lineChart = new Chart(ctx, config = {
        type: "line",
        data: {
          datasets: [{
              data: [], // start with empty y-axis dataset
              backgroundColor: gradientStroke1,
              label: "Smoke value",
              tension: 0.4,
              borderWidth: 0,
              pointRadius: 0,
              borderColor: "#2194fe",
              borderWidth: 3,
              maxBarThickness: 6,
            },
            /*{
              label: "Websites",
              tension: 0.4,
              borderWidth: 0,
              pointRadius: 0,
              borderColor: "#3A416F",
              borderWidth: 3,
              backgroundColor: gradientStroke2,
              data: [30, 90, 40, 140, 290, 290, 340, 230, 400],
              maxBarThickness: 6

            },*/
          ],
          labels: [], // start with empty x-axis dataset
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          legend: {
            display: false,
          },
          tooltips: {
            enabled: true,
            mode: "index",
            intersect: false,
          },
          scales: {
            yAxes: [{
              gridLines: {
                borderDash: [2],
                borderDashOffset: [2],
                color: '#dee2e6',
                zeroLineColor: '#dee2e6',
                zeroLineWidth: 1,
                zeroLineBorderDash: [2],
                drawBorder: false,
              },
              ticks: {
                suggestedMin: 0,
                suggestedMax: 100,
                beginAtZero: true,
                padding: 10,
                fontSize: 11,
                fontColor: '#adb5bd',
                lineHeight: 3,
                fontStyle: 'normal',
                fontFamily: "Open Sans",
              },
            }, ],
            xAxes: [{
              /*display: true,
              type: 'time',
              time: {
                parser: 'YYYY-MM-DD HH:mm:ss',
                tooltipFormat: 'll HH:mm',
                unit: 'day',
                unitStepSize: 1,
                displayFormats: {
                  'day': 'DD MM YYYY'
                }
              },*/

              gridLines: {
                zeroLineColor: 'rgba(0,0,0,0)',
                display: false,
              },
              ticks: {
                autoSkip: true,     // interval setting
                maxTicksLimit: 10,  // interval setting
                padding: 10,
                fontSize: 11,
                fontColor: '#adb5bd',
                lineHeight: 3,
                fontStyle: 'normal',
                fontFamily: "Open Sans",
              },
              
            }],
          },
        },
      });
    });
  </script>

  <!--  lineChart refresh   -->
  <script>
    function lineChartRefresh() {

      // selected sensor must have valid id first, else reset line chart
      if (global_selected_sensor == 0) {
        global_lineChart.data.datasets[0].data = [];
        global_lineChart.data.labels = [];
        global_lineChart.update();

        return;
      }

      var startDate = $("#datepicker-start").val();   // returns 2022-12-31
      var startTime = $("#timepicker-start").val();   // returns 16:43
      var endDate = $("#datepicker-end").val();
      var endTime = $("#timepicker-end").val();
      //document.getElementById("label-test").innerHTML = "New text!";

      if (startDate == "") {
        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
        var mm = String(today.getMonth() + 1).padStart(2, '0');
        var yyyy = today.getFullYear();
        today = yyyy + '-' + mm + '-' + dd;

        startDate = today;        
        document.getElementById("datepicker-start").value = startDate;
      }
      
      if (startTime == "") {
        startTime = "00:00"   // use 12am for startTime
        document.getElementById("timepicker-start").value = startTime;
      }

      if (endDate == "") {
        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
        var mm = String(today.getMonth() + 1).padStart(2, '0');
        var yyyy = today.getFullYear();
        today = yyyy + '-' + mm + '-' + dd;

        endDate = today;
        document.getElementById("datepicker-end").value = endDate;
      }
      
      if (endTime == "") {
        function getTime(d){
          function pad(n){return n<10 ? '0'+n : n}
          return [
            pad(d.getUTCHours() + 8),':',
            pad(d.getUTCMinutes()),
          ].join("");
        }

        var rawDate = new Date();
        var formattedTime = getTime(rawDate);

        endTime = formattedTime;
        document.getElementById("timepicker-end").value = endTime;
      }
      
      $.ajax({
        type: "GET",
        url: "/line-chart/" + String(global_selected_sensor) + "/" + startDate + "/" + startTime + "/" + endDate + "/" + endTime,
        success: function(response) {
          //alert(response['labels']);
          global_lineChart.data.datasets[0].data = response.data;
          global_lineChart.data.labels = response.labels;
          global_lineChart.update();
        },
        error: function(xhr, status, error) {
          http_error_handler(xhr);
        }
      });
    }

  </script>

  <!--  init scatterChart script   -->
  <script>
    $(function() {
      global_scatterChart = new Chart(ctx2, config = {
        type: "scatter",
        data: {
          datasets: [{
              data: [], // start with empty y-axis dataset
              label: "Bedroom 1",
              tension: 0.4,
              pointRadius: 1,
              borderColor: 'rgb(255, 99, 132)',
              borderWidth: 4,
              maxBarThickness: 6,
            },
            {
              data: [],
              label: "Bedroom 2",
              tension: 0.4,
              pointRadius: 1,
              borderColor: 'rgb(255, 205, 86)',
              borderWidth: 4,
              maxBarThickness: 6,
            },
            {
              data: [], 
              label: "Bedroom 3",
              tension: 0.4,
              pointRadius: 1,
              borderColor: 'rgb(75, 192, 192)',
              borderWidth: 4,
              maxBarThickness: 6,
            },
            {
              data: [],
              label: "Living room",
              tension: 0.4,
              pointRadius: 1,
              borderColor: 'rgb(54, 162, 235)',
              borderWidth: 4,
              maxBarThickness: 6,
            },
            {
              data: [],
              label: "Kitchen",
              tension: 0.4,
              pointRadius: 1,
              borderColor: 'rgb(153, 102, 255)',
              borderWidth: 4,
              maxBarThickness: 6,
            },
          ],
        },
        options: {
          //showLine: false,
          responsive: true,
          maintainAspectRatio: false,
          legend: {
            display: true,
          },
          tooltips: {
            enabled: true,
            mode: "nearest",
            intersect: true,
            callbacks: {
                label: function(tooltipItems, data) {
                  var date_from_ms = new Date(tooltipItems.xLabel);

                  // Get date format
                  var dd = String(date_from_ms.getDate()).padStart(2, '0');
                  var mmm = String(date_from_ms.toLocaleString('en-us',{month:'short'}));
                  var yyyy = date_from_ms.getFullYear();
                  formatted_date = dd + ' ' + mmm + ' ' + yyyy;

                  // Get time format
                  function getTime(d) {
                    function pad(n) {return n<10 ? '0'+n : n}
                    return [
                      pad(d.getUTCHours() + 8),':',
                      pad(d.getUTCMinutes()), ':',
                      pad(d.getUTCSeconds())
                    ].join("");
                  }
                  var formatted_time = getTime(date_from_ms);

                  // Room: data.datasets[tooltipItems.datasetIndex].label
                  
                  return formatted_date + ' ' + formatted_time;
                }
            }
          },
          scales: {
            yAxes: [{
              //display: false,
              gridLines: {
                borderDash: [2],
                borderDashOffset: [2],
                color: '#dee2e6',
                zeroLineColor: '#dee2e6',
                zeroLineWidth: 1,
                zeroLineBorderDash: [2],
                drawBorder: false,
              },
              ticks: {
                suggestedMin: 0,
                suggestedMax: 100,
                beginAtZero: true,
                padding: 10,
                fontSize: 11,
                fontColor: '#adb5bd',
                lineHeight: 3,
                fontStyle: 'normal',
                fontFamily: "Open Sans",
              },
            }, ],
            xAxes: [{
              /*display: true,
              type: 'time',
              time: {
                parser: 's',
                tooltipFormat: 'll HH:mm',
                unit: 'day',
                unitStepSize: 1,
                displayFormats: {
                  'day': 'DD MM YYYY'
                }
              },*/
              gridLines: {
                zeroLineColor: 'rgba(0,0,0,0)',
                display: false,
              },
              ticks: {
                autoSkip: true,     // interval setting
                maxTicksLimit: 10,  // interval setting
                padding: 10,
                fontSize: 11,
                fontColor: '#adb5bd',
                lineHeight: 3,
                fontStyle: 'normal',
                fontFamily: "Open Sans",
                callback: function(value, index, values) {
                  var date_from_ms = new Date(value);

                  // Get date format
                  var dd = String(date_from_ms.getDate()).padStart(2, '0');
                  var mmm = String(date_from_ms.toLocaleString('en-us',{month:'short'}));
                  var yyyy = date_from_ms.getFullYear();
                  formatted_date = dd + ' ' + mmm + ' ' + yyyy;

                  // Get time format
                  function getTime(d){
                    function pad(n){return n<10 ? '0'+n : n}
                    return [
                      pad(d.getUTCHours() + 8),':',
                      pad(d.getUTCMinutes()),
                    ].join("");
                  }
                  var formatted_time = getTime(date_from_ms);

                  return formatted_date + ' ' + formatted_time;
                }
              },
              
            }],
          },
        },
      });
    });
  </script>

  <!--  scatterChart refresh   -->
  <script>
    function scatterChartRefresh() {

      // must have selected block and unit, else reset scatter chart
      if (global_selected_block == "" || global_selected_unit == "") {
        global_scatterChart.data.datasets[0].data = [];
        global_scatterChart.data.datasets[1].data = [];
        global_scatterChart.data.datasets[2].data = [];
        global_scatterChart.data.datasets[3].data = [];
        global_scatterChart.data.datasets[4].data = [];

        global_scatterChart.update();
        return;
      }

      var startDate = $("#datepicker-start").val(); 
      var startTime = $("#timepicker-start").val(); 
      var endDate = $("#datepicker-end").val();
      var endTime = $("#timepicker-end").val();

      if (startDate == "") {
        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
        var mm = String(today.getMonth() + 1).padStart(2, '0');
        var yyyy = today.getFullYear();
        today = yyyy + '-' + mm + '-' + dd;

        startDate = today;        
        document.getElementById("datepicker-start").value = startDate;
      }
      
      if (startTime == "") {
        startTime = "00:00"   // use 12am for startTime
        document.getElementById("timepicker-start").value = startTime;
      }

      if (endDate == "") {
        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
        var mm = String(today.getMonth() + 1).padStart(2, '0');
        var yyyy = today.getFullYear();
        today = yyyy + '-' + mm + '-' + dd;

        endDate = today;
        document.getElementById("datepicker-end").value = endDate;
      }
      
      if (endTime == "") {
        function getTime(d){
          function pad(n){return n<10 ? '0'+n : n}
          return [
            pad(d.getUTCHours() + 8),':',
            pad(d.getUTCMinutes()),
          ].join("");
        }

        var rawDate = new Date();
        var formattedTime = getTime(rawDate);

        endTime = formattedTime;
        document.getElementById("timepicker-end").value = endTime;
      }
      
      $.ajax({
        type: "GET",
        url: "/scatter-chart/" + global_selected_block + "/" + global_selected_unit.slice(1,7) + "/" + startDate + "/" + startTime + "/" + endDate + "/" + endTime,
        success: function(response) {
          //alert(response['data'][0]['x']);
          global_scatterChart.data.datasets[0].data = response.data[0];
          global_scatterChart.data.datasets[1].data = response.data[1];
          global_scatterChart.data.datasets[2].data = response.data[2];
          global_scatterChart.data.datasets[3].data = response.data[3];
          global_scatterChart.data.datasets[4].data = response.data[4];

          global_scatterChart.update();
        },
        error: function(xhr, status, error) {
          http_error_handler(xhr);
        }
      });
    }

  </script>

  <!--  init barChart script   -->
  <script>
      $(function() {
      global_barChart = new Chart(ctx3, config = {
        type: "bar",
        data: {
          datasets: [{
              borderWidth: 1,
              maxBarThickness: 20,
              data: [65, 59, 80, 81, 56], // start with empty y-axis dataset
              backgroundColor: [
                'rgba(255, 99, 132, 0.2)',
                'rgba(255, 205, 86, 0.2)',
                'rgba(75, 192, 192, 0.2)',
                'rgba(54, 162, 235, 0.2)',
                'rgba(153, 102, 255, 0.2)',
              ],
              borderColor: [
                'rgb(255, 99, 132)',
                'rgb(255, 205, 86)',
                'rgb(75, 192, 192)',
                'rgb(54, 162, 235)',
                'rgb(153, 102, 255)',
              ],
            },
          ],
          labels: ['Bedroom 1', 'Bedroom 2', 'Bedroom 3', 'Living room', 'Kitchen'],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          legend: {
            display: false,
          },
          tooltips: {
            enabled: true,
            mode: "index",
            intersect: false,
          },
          scales: {
            yAxes: [{
              gridLines: {
                borderDash: [2],
                borderDashOffset: [2],
                color: '#dee2e6',
                zeroLineColor: '#dee2e6',
                zeroLineWidth: 1,
                zeroLineBorderDash: [2],
                drawBorder: false,
              },
              ticks: {
                suggestedMin: 0,
                suggestedMax: 100,
                beginAtZero: true,
                padding: 10,
                fontSize: 11,
                fontColor: '#adb5bd',
                lineHeight: 3,
                fontStyle: 'normal',
                fontFamily: "Open Sans",
              },
            }, ],
            xAxes: [{
              
              /*display: true,
              type: 'time',
              time: {
                parser: 'YYYY-MM-DD HH:mm:ss',
                tooltipFormat: 'll HH:mm',
                unit: 'day',
                unitStepSize: 1,
                displayFormats: {
                  'day': 'DD MM YYYY'
                }
              },*/

              gridLines: {
                zeroLineColor: 'rgba(0,0,0,0)',
                display: false,
              },
              ticks: {
                autoSkip: true,     // interval setting
                maxTicksLimit: 10,  // interval setting
                padding: 10,
                fontSize: 11,
                fontColor: '#adb5bd',
                lineHeight: 3,
                fontStyle: 'normal',
                fontFamily: "Open Sans",
              },
              
            }],
          },
        },
      });
    });
  </script>

  <!--  init radio btns script  -->
  <script>
      var radioBtn_s1 = document.getElementById("radioBtn_s1");
      var radioBtn_s2 = document.getElementById("radioBtn_s2");
      var radioBtn_s3 = document.getElementById("radioBtn_s3");
      var radioBtn_s4 = document.getElementById("radioBtn_s4");
      var radioBtn_s5 = document.getElementById("radioBtn_s5");

      radioBtn_s1.disabled = true;
      radioBtn_s2.disabled = true;
      radioBtn_s3.disabled = true;
      radioBtn_s4.disabled = true;
      radioBtn_s5.disabled = true;
  </script>

  <!--  dropDownLists onClick: update dashboard context script 	-->
  <script>
    function dropDownItem_Unit_onClick(selected_unit) {

      // if selected unit = previously selected unit, dont refresh line chart & rb info table
      var unitNameText = document.getElementById("text_unitName");

      if (unitNameText.innerHTML == selected_unit) {
        return;
      }     

      // else, set corresponding text
      global_selected_unit = selected_unit;
      unitNameText.innerHTML = selected_unit;

      // uncheck + enable all radio btns
      var radioBtn_s1 = document.getElementById("radioBtn_s1");
      var radioBtn_s2 = document.getElementById("radioBtn_s2");
      var radioBtn_s3 = document.getElementById("radioBtn_s3");
      var radioBtn_s4 = document.getElementById("radioBtn_s4");
      var radioBtn_s5 = document.getElementById("radioBtn_s5");

      radioBtn_s1.disabled = false;
      radioBtn_s2.disabled = false;
      radioBtn_s3.disabled = false;
      radioBtn_s4.disabled = false;
      radioBtn_s5.disabled = false;

      radioBtn_s1.checked = false;
      radioBtn_s2.checked = false;
      radioBtn_s3.checked = false;
      radioBtn_s4.checked = false;
      radioBtn_s5.checked = false;

      // close dropdownlist_unit
      var searchUnitText = document.getElementById("textfield_searchUnit");
      var dropdowns = document.getElementsByClassName("dropdown-content-unit");

      ddlUnit_isOpen = false;

      if (searchUnitText.value != "") {
        searchUnitText.value = "";
        filterUnitFunction();
      }
      
      for (let i = 0; i < dropdowns.length; i++) {
        var openDropdown = dropdowns[i];
        if (openDropdown.classList.contains('dropdown-toggle')) {
          openDropdown.classList.remove('dropdown-toggle');
        }
      }

      // call line chart reset
      var text_lineChartTitle = document.getElementById("text_lineChartTitle");
      text_lineChartTitle.innerHTML = "Sensor Reading by Room -";
      global_selected_sensor = 0;

      lineChartRefresh();
      scatterChartRefresh();

      $.ajax({
        type: "GET",
        url: "/fetchUnitInfo/" + global_selected_block + "/" + global_selected_unit.slice(1,7), // remove '#' from #14-101 to prevent interfere w/ url
        success: function(response) {

          // set corresponding text
          var flatTypeText = document.getElementById("text_flatType");
          flatTypeText.innerHTML = response['unit_info'][0][5];

          // set corresponding text for 'raspberry info' table
          var isBedroom1Updated = false;
          var isBedroom2Updated = false;
          var isBedroom3Updated = false;
          var isLivingRoomUpdated = false;
          var isKitchenUpdated = false;

          var rbIdText_1 = document.getElementById("text_raspberryId1");
          var rbIdText_2 = document.getElementById("text_raspberryId2");
          var rbIdText_3 = document.getElementById("text_raspberryId3");
          var rbIdText_4 = document.getElementById("text_raspberryId4");
          var rbIdText_5 = document.getElementById("text_raspberryId5");

          var rbStatusText_1 = document.getElementById("text_raspberryStatus1");
          var rbStatusText_2 = document.getElementById("text_raspberryStatus2");
          var rbStatusText_3 = document.getElementById("text_raspberryStatus3");
          var rbStatusText_4 = document.getElementById("text_raspberryStatus4");
          var rbStatusText_5 = document.getElementById("text_raspberryStatus5");

          // algorithm to update 'raspberry info' html based on given room names from JsonResponse
          response['unit_info'].forEach(function(element) {
            switch(element[4]) {

              case 'Bedroom 1':
                rbIdText_1.innerHTML = element[3];
                sensorSelectTranslate["sens1"] = element[3];
                isBedroom1Updated = true;
                break;

              case 'Bedroom 2':
                rbIdText_2.innerHTML = element[3];
                sensorSelectTranslate["sens2"] = element[3];
                isBedroom2Updated = true;
                break;

              case 'Bedroom 3':
                rbIdText_3.innerHTML = element[3];
                sensorSelectTranslate["sens3"] = element[3];
                isBedroom3Updated = true;
                break;

              case 'Living room':
                rbIdText_4.innerHTML = element[3];
                sensorSelectTranslate["sens4"] = element[3];
                isLivingRoomUpdated = true;
                break;

              case 'Kitchen':
                rbIdText_5.innerHTML = element[3];
                sensorSelectTranslate["sens5"] = element[3];
                isKitchenUpdated = true;
                break;

              default:
                break;
            }
          });

          // if room name not in jsonResponse, set html for that room to display no info
          if (!isBedroom1Updated) {
            rbIdText_1.innerHTML = "-";
            sensorSelectTranslate["sens1"] = 0;
            radioBtn_s1.disabled = true;
          }
          if (!isBedroom2Updated) {
            rbIdText_2.innerHTML = "-";
            sensorSelectTranslate["sens2"] = 0;
            radioBtn_s2.disabled = true;
          }
          if (!isBedroom3Updated) {
            rbIdText_3.innerHTML = "-";
            sensorSelectTranslate["sens3"] = 0;
            radioBtn_s3.disabled = true;
          }
          if (!isLivingRoomUpdated) {
            rbIdText_4.innerHTML = "-";
            sensorSelectTranslate["sens4"] = 0;
            radioBtn_s4.disabled = true;
          }
          if (!isKitchenUpdated) {
            rbIdText_5.innerHTML = "-";
            sensorSelectTranslate["sens5"] = 0;
            radioBtn_s5.disabled = true;
          }
        },
        error: function(xhr, status, error) {
          http_error_handler(xhr);
        }
      });

    }

    function dropDownItem_Block_onClick(selected_block) {

      // if selected block = previously selected block, dont refresh dashboard
      var blockNameText = document.getElementById("text_blockName");
      var unitNameText = document.getElementById("text_unitName");
      var flatTypeText = document.getElementById("text_flatType");

      if (blockNameText.innerHTML == selected_block) {
        return;
      }   

      // else, update corresponding text
      global_selected_block = selected_block;
      blockNameText.innerHTML = selected_block;
      unitNameText.innerHTML = "-"; 
      flatTypeText.innerHTML = "-";

      // close dropdownlist_block + reset ddl's search field
      var searchBlockText = document.getElementById("textfield_searchBlock");
      var dropdowns = document.getElementsByClassName("dropdown-content-block");

      ddlBlock_isOpen = false;

      if (searchBlockText.value != "") {
        searchBlockText.value = "";
        filterBlockFunction();
      }

      for (let i = 0; i < dropdowns.length; i++) {
        var openDropdown = dropdowns[i];
        if (openDropdown.classList.contains('dropdown-toggle')) {
          openDropdown.classList.remove('dropdown-toggle');
        }
      }
      
      // uncheck + disable all radio btns
      var radioBtn_s1 = document.getElementById("radioBtn_s1");
      var radioBtn_s2 = document.getElementById("radioBtn_s2");
      var radioBtn_s3 = document.getElementById("radioBtn_s3");
      var radioBtn_s4 = document.getElementById("radioBtn_s4");
      var radioBtn_s5 = document.getElementById("radioBtn_s5");

      radioBtn_s1.disabled = true;
      radioBtn_s2.disabled = true;
      radioBtn_s3.disabled = true;
      radioBtn_s4.disabled = true;
      radioBtn_s5.disabled = true;

      radioBtn_s1.checked = false;
      radioBtn_s2.checked = false;
      radioBtn_s3.checked = false;
      radioBtn_s4.checked = false;
      radioBtn_s5.checked = false;

      // reset 'raspberry pi info' table
      var rbIdText_1 = document.getElementById("text_raspberryId1");
      var rbIdText_2 = document.getElementById("text_raspberryId2");
      var rbIdText_3 = document.getElementById("text_raspberryId3");
      var rbIdText_4 = document.getElementById("text_raspberryId4");
      var rbIdText_5 = document.getElementById("text_raspberryId5");

      rbIdText_1.innerHTML = "-";
      rbIdText_2.innerHTML = "-";
      rbIdText_3.innerHTML = "-";
      rbIdText_4.innerHTML = "-";
      rbIdText_5.innerHTML = "-";

      /*var rbStatusText_1 = document.getElementById("text_raspberryStatus1");
      var rbStatusText_2 = document.getElementById("text_raspberryStatus2");
      var rbStatusText_3 = document.getElementById("text_raspberryStatus3");
      var rbStatusText_4 = document.getElementById("text_raspberryStatus4");
      var rbStatusText_5 = document.getElementById("text_raspberryStatus5");

      rbStatusText_1.innerHTML = "-";
      rbStatusText_2.innerHTML = "-";
      rbStatusText_3.innerHTML = "-";
      rbStatusText_4.innerHTML = "-";
      rbStatusText_5.innerHTML = "-";*/


      // call line chart reset
      var text_lineChartTitle = document.getElementById("text_lineChartTitle");
      text_lineChartTitle.innerHTML = "Sensor Reading by Room -";
      global_selected_sensor = 0;
      global_selected_unit = ""

      lineChartRefresh();  
      scatterChartRefresh();

      $.ajax({
        type: "GET",
        url: "/fetchUnits/" + selected_block,
        success: function(response) {

          // update corresponding text
          var unitAreaText = document.getElementById("text_area");
          var unitStreetText = document.getElementById("text_street");

          unitAreaText.innerHTML = response['units'][0][6];
          unitStreetText.innerHTML = response['units'][0][7];

          // delete existing units in dropdownlist_units
          const unitOptions = document.querySelectorAll('.dropdown-item-unit');
          unitOptions.forEach(unit => {
            unit.remove();
          });

          // algorithm to filter out repeating unit numbers, we want distinct units
          var array = response['units'];
          var unique = [];
          var distinct = [];
          for( let i = 0; i < array.length; i++ ){
            if( !unique[array[i][2]]){
              distinct.push(array[i][2]);
              unique[array[i][2]] = 1;
            }
          }
            
          // add filtered units into dropdownlist_units
          distinct.forEach(function(element) {
            const parentElement = document.querySelector('#ddlUnit_content');
            const div = document.createElement('div');
            div.innerHTML = '<a class="dropdown-content-item dropdown-item-unit font-weight-bold" onclick="dropDownItem_Unit_onClick(this.innerText)">' + element + '</a>';
            parentElement.appendChild(div);
          });

          // open dropdownlist_units
          if (!ddlUnit_isOpen) {
            btnChangeUnit_onClick();
          }

        },
        error: function(xhr, status, error) {
          http_error_handler(xhr);
        }
      });
    }

  </script>

  <!--  init dropdownlist_blocks script 	-->
  <script>
    $(function() {
      $.ajax({
        type: "GET",
        url: "/fetchBlocks",
        success: function(response) {

          // add blocks into dropdownlist for blocks
          response['blocks'].forEach(function(element) {
            const parentElement = document.querySelector('#ddlBlock_content');
            const div = document.createElement('div');
            div.innerHTML = '<a class="dropdown-content-item font-weight-bold" onclick="dropDownItem_Block_onClick(this.innerText)">' + element + '</a>';
            parentElement.appendChild(div);
          });

        },
        error: function(xhr, status, error) {
          http_error_handler(xhr);
        }
      });
    });

  </script>

  <!--  dropdownlist_block&unit isToggled + own search bar script   -->
  <script>
    function btnChangeBlock_onClick() {
      document.getElementById("ddlBlock_content").classList.toggle("dropdown-toggle");
      ddlBlock_isOpen = true;
    }

    function btnChangeUnit_onClick() {
      document.getElementById("ddlUnit_content").classList.toggle("dropdown-toggle");
      ddlUnit_isOpen = true;
    }

    const onClickOutside = (e) => {
      // if either dropdownlists are open + mouse click occured outside
      if ((ddlBlock_isOpen || ddlUnit_isOpen) && !e.target.className.includes('dropdown-content-item')) {

        ddlBlock_isOpen = false;
        ddlUnit_isOpen = false;
        var dropdowns = document.getElementsByClassName("dropdown-content");
        var searchBlockText = document.getElementById("textfield_searchBlock");
        var searchUnitText = document.getElementById("textfield_searchUnit");

        // reset dropdown searchBlock text
        if (searchBlockText.value != "") {
          searchBlockText.value = "";
          filterBlockFunction();
        }

        // reset dropdown searchUnit text
        if (searchUnitText.value != "") {
          searchUnitText.value = "";
          filterUnitFunction();
        }        

        // close drop down list
        for (let i = 0; i < dropdowns.length; i++) {
          var openDropdown = dropdowns[i];
          if (openDropdown.classList.contains('dropdown-toggle')) {
            openDropdown.classList.remove('dropdown-toggle');
          }
        }

      }
    };

    window.addEventListener("click", onClickOutside);

    function filterBlockFunction() {
      var input = document.getElementById("textfield_searchBlock");
      var filter = input.value.toUpperCase();

      var div = document.getElementById("ddlBlock_content");
      var a = div.getElementsByTagName("a");

      for (let i = 0; i < a.length; i++) {
        txtValue = a[i].textContent || a[i].innerText;
        if (txtValue.toUpperCase().indexOf(filter) > -1) {
          a[i].style.display = "";
        } else {
          a[i].style.display = "none";
        }
      }
    }

    function filterUnitFunction() {
      var input = document.getElementById("textfield_searchUnit");
      var filter = input.value.toUpperCase();

      var div = document.getElementById("ddlUnit_content");
      var a = div.getElementsByTagName("a");

      for (let i = 0; i < a.length; i++) {
        txtValue = a[i].textContent || a[i].innerText;
        if (txtValue.toUpperCase().indexOf(filter) > -1) {
          a[i].style.display = "";
        } else {
          a[i].style.display = "none";
        }
      }
    }

  </script>

  <!--  http error handler script   -->
  <script>
    function http_error_handler(request) {
      if (xhr.status === 400) {
        // Bad/invalid request
        alert("We're sorry, but there seems to be a problem with the request you are trying to make.");
      } else if (xhr.status === 401) {
        // Unauthorized
        alert("We're sorry, but you are not authorized to access the requested resource.");
      } else if (xhr.status === 403) {
        // Forbidden
        alert("We're sorry, but you are not permitted to access the requested resource.");
      } else if (xhr.status === 404) {
        // Not found
        alert('The resource you are looking for does not exist.');
      } else if (xhr.status === 408) {
        // Request Timeout
        alert("Your request has timed out.");
      } else if (xhr.status === 500) {
        // Not found
        alert("We're sorry, but there has been an error on the server");
      } else {
        // Other error
        alert('An error occurred: ' + error);
      }
    }
  </script>

  <!--  rpi radioBtn onClick: update line chart script   -->
  <script>  
    function sensor_onClick(selected_sensor) {
      var text_lineChartTitle = document.getElementById("text_lineChartTitle");

      text_lineChartTitle.innerHTML = "Sensor Reading by Room " + selected_sensor;
      global_selected_sensor = sensorSelectTranslate["sens" + selected_sensor];
      lineChartRefresh();
    }
  </script>

  <!--  lineChart datetime range checker script   -->
  <script>
    function dt_range_check() {
      current_date_start = document.getElementById("datepicker-start").value;
      current_date_end = document.getElementById("datepicker-end").value;
      current_time_start = document.getElementById("timepicker-start").value;
      current_time_end = document.getElementById("timepicker-end").value;

      if (current_date_start > current_date_end) {
        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
        var mm = String(today.getMonth() + 1).padStart(2, '0');
        var yyyy = today.getFullYear();
        today = yyyy + '-' + mm + '-' + dd;

        document.getElementById("datepicker-end").value = today;
        document.getElementById("timepicker-start").value = "00:00";
        alert("Invalid date. Please select a date within the acceptable range.");
      }

      else if (current_date_start == current_date_end && current_time_start > current_time_end) {        
        document.getElementById("timepicker-start").value = "00:00";
        alert("Invalid time. Please select a time within the acceptable range.");
      }

      lineChartRefresh();
      scatterChartRefresh();
    }
  </script>

  

{% endblock javascripts %}
